$(window).on("load",(function(){!function(){if(is_mobile()){if(null!=navigator.userAgent.match(/iPad/i))return!1;var e=$("._buttons").find(".btn-with-tooltip");$.each(e,(function(){var e=$(this).attr("title");void 0===e&&(e=$(this).attr("data-title")),void 0!==e&&($(this).append(" "+e),$(this).removeClass("btn-with-tooltip"))})),e=$("._buttons").find(".btn-with-tooltip-group"),$.each(e,(function(){var e=$(this).attr("title");void 0===e&&(e=$(this).attr("data-title")),void 0!==e&&($(this).find(".btn").eq(0).append(" "+e),$(this).removeClass("btn-with-tooltip-group"))}))}}()})),$.fn.dataTable.ext.errMode="throw",$.fn.dataTableExt.oStdClasses.sWrapper="dataTables_wrapper form-inline dt-bootstrap table-loading","1"==app.options.enable_google_picker&&($.fn.googleDrivePicker.defaults.clientId=app.options.google_client_id,$.fn.googleDrivePicker.defaults.developerKey=app.options.google_api),Dropzone.options.newsFeedDropzone=!1,Dropzone.options.salesUpload=!1,"Notification"in window&&"1"==app.options.desktop_notifications&&Notification.requestPermission();var e,t,a,i,n,s,o=get_url_param("tab"),d=get_url_param("group"),l=$("#side-menu"),r=$("#wrapper"),c=$("#setup-menu-wrapper"),p=$("#calendar"),u=$("#header").find("li.notifications-wrapper"),m=document.title,h=0,f=0,_=0,v=0,g=0,b=!1,y=0,k=null,w=$("#setup-menu-item");function C(){var e,t;"1"==app.options.has_permission_tasks_checklist_items_delete&&(e=$("body").find(".checklist-templates-wrapper ul.dropdown-menu li").not(":first-child"),t=$("body").find(".checklist-templates-wrapper select option").not(":first-child"),$.each(t,(function(t,a){a=$(a),0===$(e[t]).find(".checklist-item-template-remove").length&&$(e[t]).find("a > span.text").after('<small class="checklist-item-template-remove" onclick="remove_checklist_item_template('+a.attr("value")+'); event.stopPropagation();"><i class="fa fa-remove"></i></small>')})))}function T(e,t){var a,i,n,s=$("#task_select");0<s.length&&(s.find("option").filter((function(){return this.value||0<$.trim(this.value).length||0<$.trim(this.text).length})).remove(),$.each(e,(function(e,t){a=" ",!0===t.started_timers?a+='disabled class="text-danger important" data-subtext="'+app.lang.invoice_task_billable_timers_found+'"':!1===t.started_timers&&"project"!=t.rel_type&&(a+='data-subtext="'+t.rel_name+'"'),s.append('<option value="'+t.id+'"'+a+">"+t.name+"</option>")})),(i=$(".input-group-addon-bill-tasks-help")).find(".popover-invoker").popover("destroy"),i.empty(),"",n=empty(t)?app.lang.invoice_task_item_project_tasks_not_included:app.lang.showing_billable_tasks_from_project+" "+$("#project_id option:selected").text().trim(),i.html('<span class="pointer popover-invoker" data-container=".form-group-select-task_select" data-trigger="click" data-placement="top" data-toggle="popover" data-content="'+n+'"><i class="fa fa-question-circle"></i></span>'),delay((function(){(3>i.attr("info-shown-count")||void 0===i.attr("info-shown-count"))&&$(".projects-wrapper").is(":visible")&&0<e.length&&(i.attr("info-shown-count",void 0===i.attr("info-shown-count")?1:parseInt(i.attr("info-shown-count"))+1),i.find(".popover-invoker").click())}),3500)),s.selectpicker("refresh")}function S(){var e=l.height(),t=$("#wrapper").find(".content").height();c.css("min-height",$(document).outerHeight(!0)-126+"px"),r.css("min-height",$(document).outerHeight(!0)-63+"px"),t<e&&r.css("min-height",e+"px"),t<e&&e<$(window).height()&&r.css("min-height",$(window).height()-63+"px"),e<t&&t<$(window).height()&&r.css("min-height",$(window).height()-63+"px"),is_mobile()&&"true"==isRTL&&l.css("min-height",$(document).outerHeight(!0)-63+"px")}function D(){769>$(this).width()?$("body").addClass("page-small"):$("body").removeClass("page-small show-sidebar")}function j(e){appDataTableInline(e,{supportsButtons:!0,supportsLoading:!0,autoWidth:!1})}function F(e,t,a,i,n,s){var o="string"==typeof e?$("body").find("table"+e):e;if(0===o.length)return!1;n="undefined"==n||void 0===n?[]:n,void 0===s?s=[[0,"asc"]]:1===s.length&&(s=[s]);var d=o.attr("data-default-order");if(!empty(d)){var l,r=JSON.parse(d),c=[];for(l in r)0<o.find("thead th:eq("+r[l][0]+")").length&&c.push(r[l]);0<c.length&&(s=c)}e=[10,25,50,100],d=[10,25,50,100],app.options.tables_pagination_limit=parseFloat(app.options.tables_pagination_limit),-1==$.inArray(app.options.tables_pagination_limit,e)&&(e.push(app.options.tables_pagination_limit),d.push(app.options.tables_pagination_limit)),e.sort((function(e,t){return e-t})),d.sort((function(e,t){return e-t})),e.push(-1),d.push(app.lang.dt_length_menu_all);t={language:app.lang.datatables,processing:!0,retrieve:!0,serverSide:!0,paginate:!0,searchDelay:750,bDeferRender:!0,autoWidth:!1,dom:"<'row'><'row'<'col-md-7'lB><'col-md-5'f>>rt<'row'<'col-md-4'i>><'row'<'#colvis'><'.dt-page-jump'>p>",pageLength:app.options.tables_pagination_limit,lengthMenu:[e,d],columnDefs:[{searchable:!1,targets:a},{sortable:!1,targets:i}],fnDrawCallback:function(e){_table_jump_to_page(this,e),0===e.aoData.length?$(e.nTableWrapper).addClass("app_dt_empty"):$(e.nTableWrapper).removeClass("app_dt_empty")},fnCreatedRow:function(e,t,a){$(e).attr("data-title",t.Data_Title),$(e).attr("data-toggle",t.Data_Toggle)},initComplete:function(e,t){var a=this,i=$(".btn-dt-reload");i.attr("data-toggle","tooltip"),i.attr("title",app.lang.dt_button_reload),(i=$(".dt-column-visibility")).attr("data-toggle","tooltip"),i.attr("title",app.lang.dt_button_column_visibility),a.wrap('<div class="table-responsive"></div>'),(i=a.find(".dataTables_empty")).length&&i.attr("colspan",a.find("thead th").length),is_mobile()&&400>$(window).width()&&0<a.find('tbody td:first-child input[type="checkbox"]').length&&(a.DataTable().column(0).visible(!1,!1).columns.adjust(),$("a[data-target*='bulk_actions']").addClass("hide")),a.parents(".table-loading").removeClass("table-loading"),a.removeClass("dt-table-loading"),i=a.find("thead th:last-child"),a=a.find("thead th:first-child"),i.text().trim()==app.lang.options&&i.addClass("not-export"),0<a.find('input[type="checkbox"]').length&&a.addClass("not-export"),S()},order:s,ajax:{url:t,type:"POST",data:function(e){for(var t in"undefined"!=typeof csrfData&&(e[csrfData.token_name]=csrfData.hash),n)e[t]=$(n[t]).val();o.attr("data-last-order-identifier")&&(e.last_order_identifier=o.attr("data-last-order-identifier"))}},buttons:get_datatable_buttons(o)};var p=(o=o.dataTable(t)).DataTable(),u=(t=o.find("th.not_visible"),[]);if($.each(t,(function(){u.push(this.cellIndex)})),setTimeout((function(){for(var e in u)p.columns(u[e]).visible(!1,!1).columns.adjust()}),10),o.hasClass("customizable-table")){t=o.find("th.toggleable");var m=$("#hidden-columns-"+o.attr("id"));try{m=JSON.parse(m.text())}catch(e){m=[]}$.each(t,(function(){var e=$(this).attr("id");-1<$.inArray(e,m)&&p.column("#"+e).visible(!1)}))}return o.is(":hidden")&&o.find(".dataTables_empty").attr("colspan",o.find("thead th").length),o.on("preXhr.dt",(function(e,t,a){t.jqXHR&&t.jqXHR.abort()})),p}function A(){var e=$(".unfinished-todos li:not(.no-todos)"),t=$(".finished-todos li:not(.no-todos)"),a=1;$.each(e,(function(){$(this).find('input[name="todo_order"]').val(a),$(this).find('input[name="finished"]').val(0),a++})),0===e.length?($(".nav-total-todos").addClass("hide"),$(".unfinished-todos li.no-todos").removeClass("hide")):0<e.length&&($(".unfinished-todos li.no-todos").hasClass("hide")||$(".unfinished-todos li.no-todos").addClass("hide"),$(".nav-total-todos").removeClass("hide").html(e.length)),x=1,$.each(t,(function(){$(this).find('input[name="todo_order"]').val(x),$(this).find('input[name="finished"]').val(1),$(this).find('input[type="checkbox"]').prop("checked",!0),a++,x++})),0===t.length?$(".finished-todos li.no-todos").removeClass("hide"):0<t.length&&($(".finished-todos li.no-todos").hasClass("hide")||$(".finished-todos li.no-todos").addClass("hide"));var i=[];$.each(e,(function(){var e=$(this).find(".todo-description");e.hasClass("line-throught")&&e.removeClass("line-throught"),$(this).find('input[type="checkbox"]').prop("checked",!1),i.push([$(this).find('input[name="todo_id"]').val(),$(this).find('input[name="todo_order"]').val(),$(this).find('input[name="finished"]').val()])})),$.each(t,(function(){var e=$(this).find(".todo-description");e.hasClass("line-throught")||e.addClass("line-throught"),i.push([$(this).find('input[name="todo_id"]').val(),$(this).find('input[name="todo_order"]').val(),$(this).find('input[name="finished"]').val()])})),(data={}).data=i,$.post(admin_url+"todo/update_todo_items_order",data)}function z(e,t){appDatepicker({element_date:e,element_time:t})}function O(){appColorPicker()}function q(){appSelectPicker()}function N(){appLightbox()}function I(){appTagsInput()}function P(e,t,a,i){return tinymce.activeEditor.windowManager.open({file:admin_url+"misc/tinymce_file_browser",title:app.lang.media_files,width:900,height:450,resizable:"yes"},{setUrl:function(t){i.document.getElementById(e).value=t}}),!1}function H(e,t){e=void 0===e?".tinymce":e;var a=$(e);if(0!==a.length){$.each(a,(function(){$(this).hasClass("tinymce-manual")&&$(this).removeClass("tinymce")}));var i={branding:!1,selector:e,browser_spellcheck:!0,height:400,theme:"modern",skin:"babil",language:app.tinymce_lang,relative_urls:!1,inline_styles:!0,verify_html:!1,cleanup:!1,autoresize_bottom_margin:25,valid_elements:"+*[*]",valid_children:"+body[style], +style[type]",apply_source_formatting:!1,remove_script_host:!1,removed_menuitems:"newdocument restoredraft",forced_root_block:!1,autosave_restore_when_empty:!1,fontsize_formats:"8pt 10pt 12pt 14pt 18pt 24pt 36pt",setup:function(e){e.on("init",(function(){this.getDoc().body.style.fontSize="12pt"}))},table_default_styles:{width:"100%"},plugins:["advlist autoresize autosave lists link image print hr codesample","visualblocks code fullscreen","media save table contextmenu","paste textcolor colorpicker"],toolbar1:"fontselect fontsizeselect | forecolor backcolor | bold italic | alignleft aligncenter alignright alignjustify | image link | bullist numlist | restoredraft",file_browser_callback:P,contextmenu:"link image inserttable | cell row column deletetable | paste"};if("true"==isRTL&&(i.directionality="rtl"),"true"==isRTL&&(i.plugins[0]+=" directionality"),void 0!==t)for(var n in t)"append_plugins"!=n?i[n]=t[n]:i.plugins.push(t[n]);return e=tinymce.init(i),$(document).trigger("app.editor.initialized"),e}}function L(e){e=e?$("#form-reminder-"+e):$('[id^="form-reminder-"]'),$.each(e,(function(e,t){$(t).appFormValidator({rules:{date:"required",staff:"required",description:"required"},submitHandler:E})}))}function E(e){var t=(e=$(e)).serialize();return $.post(e.attr("action"),t).done((function(t){""!==(t=JSON.parse(t)).message&&alert_float(t.alert_type,t.message),e.trigger("reinitialize.areYouSure"),$("#task-modal").is(":visible")&&ue(t.taskHtml),J()})),($("body").hasClass("all-reminders")?$(".reminder-modal--"):$(".reminder-modal-"+e.find('[name="rel_type"]').val()+"-"+e.find('[name="rel_id"]').val())).modal("hide"),!1}function J(){$.each([".table-reminders",".table-reminders-leads",".table-my-reminders"],(function(e,t){$.fn.DataTable.isDataTable(t)&&$("body").find(t).DataTable().ajax.reload()}))}function M(e,t){$("body").find("div.dt-loader").remove();var a=$(".kan-ban-content-wrapper");a.css("max-height",window.innerHeight-e+"px"),$(".kan-ban-content").css("min-height",window.innerHeight-e+"px"),a=parseInt(a.length),$(".container-fluid").css("min-width",a*t+"px")}function R(e,t,a,i,n,s){var o,d,l,r;0!==$("#kan-ban").length&&(o=[],$.each($("#kanban-params input"),(function(){""!==(d="checkbox"!=$(this).attr("type")||!0===$(this).prop("checked")?$(this).val():"")&&(o[$(this).attr("name")]=d)})),void 0!==(r=$('input[name="search"]').val())&&""!==r&&(o.search=r),l=$('input[name="sort_type"]'),r=$('input[name="sort"]').val(),0!=l.length&&""!==l.val()&&(o.sort_by=l.val(),o.sort=r),o.kanban=!0,e=buildUrl(e=admin_url+e,o),delay((function(){$("body").append('<div class="dt-loader"></div>'),$("#kan-ban").load(e,(function(){M(i,n),void 0!==s&&s(),$(".status").sortable({connectWith:a,helper:"clone",appendTo:"#kan-ban",placeholder:"ui-state-highlight-card",revert:"invalid",scrollingSensitivity:50,scrollingSpeed:70,sort:function(e,t){var a=t.placeholder[0].parentNode;a=$(a).parents(".kan-ban-content-wrapper")[0];(t=$(a).offset()).top+a.offsetHeight-e.pageY<20?a.scrollTop=a.scrollTop+60:e.pageY-t.top<20&&(a.scrollTop=a.scrollTop-60),t.left+a.offsetWidth-e.pageX<20?a.scrollLeft=a.scrollLeft+60:e.pageX-t.left<20&&(a.scrollLeft=a.scrollLeft-60)},change:function(){var e=$(this).closest("ul"),t=$(e).find(".kanban-load-more");$(e).append($(t).detach())},start:function(e,t){$("body").css("overflow","hidden"),$(t.helper).addClass("tilt"),$(t.helper).find(".panel-body").css("background","#fbfbfb"),tilt_direction($(t.helper))},stop:function(e,t){$("body").removeAttr("style"),$(t.helper).removeClass("tilt"),$("html").off("mousemove",$(t.helper).data("move_handler")),$(t.helper).removeData("move_handler")},update:function(e,a){t(a,this)}}),$(".status").sortable({cancel:".not-sortable"})}))}),200))}function U(){$("#new-post-form textarea").val(""),$("#post-visibility").selectpicker("deselectAll")}function B(e){f<=v&&($.post(admin_url+"newsfeed/load_likes_modal",{page:f,postid:e}).done((function(e){f++,$("#modal_post_likes_wrapper").append(e)})),v-1<=f&&$(".likes_modal .modal-footer").addClass("hide"))}function Q(e){_<=g&&($.post(admin_url+"newsfeed/load_comment_likes_model",{page:_,commentid:e}).done((function(e){_++,$("#modal_comment_likes_wrapper").append(e)})),g-1<=_&&$(".likes_modal .modal-footer").addClass("hide"))}function Y(e){var t={};t.postid=e,$.post(admin_url+"newsfeed/load_newsfeed",t).done((function(e){var t=$("#newsfeed_data").find(".pinned").length;0===t?$("#newsfeed_data").prepend(e):(t=$("#newsfeed_data").find(".pinned").eq(t-1),$(t).after(e))}))}function V(e){var t={};t.page=h,void 0!==e&&0!=e&&(t.postid=e),e=$('input[name="total_pages_newsfeed"]').val(),h<=e&&$.post(admin_url+"newsfeed/load_newsfeed",t).done((function(e){h++,$("#newsfeed_data").append(e)}))}function W(e){var t=$(e).data("postid");$.post(admin_url+"newsfeed/add_comment",{content:$(e).val(),postid:t}).done((function(a){!0!==(a=JSON.parse(a)).success&&"true"!=a.success||($(e).val(""),0<$("body").find('[data-comments-postid="'+t+'"] .post-comment').length?$("body").find('[data-comments-postid="'+t+'"] .post-comment').prepend(a.comment):function(e){$.post(admin_url+"newsfeed/init_post_comments/"+e+"?refresh_post_comments=true").done((function(t){$('[data-comments-postid="'+e+'"]').html(t)}))}(t))}))}function G(e,t){$("#task-modal").is(":visible")&&$("#task-modal").modal("hide"),Z(e,void 0,t)&&$("#lead-modal").modal("show")}function X(e){var a=(e=$(e)).serialize();return $("#lead-modal").find('input[name="leadid"]').val(),$(".lead-save-btn").addClass("disabled"),$.post(e.attr("action"),a).done((function(e){""!==(e=JSON.parse(e)).message&&alert_float("success",e.message),e.proposal_warning&&0!=e.proposal_warning?($("body").find("#lead_proposal_warning").removeClass("hide"),$("body").find("#lead-modal").animate({scrollTop:0},800)):K(e,e.id),$.fn.DataTable.isDataTable(".table-leads")?t.DataTable().ajax.reload(null,!1):$("body").hasClass("kan-ban-body")&&ae()})).fail((function(e){return alert_float("danger",e.responseText),!1})),!1}function K(e,t){var a=window.location.hash,i=$("#lead-modal");$("#lead_reminder_modal").html(e.leadView.reminder_data),i.find(".data").html(e.leadView.data),i.modal({show:!0,backdrop:"static"}),I(),q(),L(),z(),O(),function(){var e={name:"required",source:"required",status:{required:{depends:function(e){return!(0<$("[lead-is-junk-or-lost]").length)}}}},t={};$.each(leadUniqueValidationFields,(function(a,i){e[i]={},"email"==i&&(e[i].email=!0),e[i].remote={url:admin_url+"leads/validate_unique_field",type:"post",data:{field:i,lead_id:function(){return $("#lead-modal").find('input[name="leadid"]').val()}}},void 0!==app.lang[i+"_exists"]&&(t[i]={remote:app.lang[i+"_exists"]})})),appValidateForm($("#lead_form"),e,X,t)}(),-1<["#tab_lead_profile","#attachments","#lead_notes","#lead_activity","#gdpr"].indexOf(a)&&(window.location.hash=a),j($("#consentHistoryTable")),$("#lead-modal").find(".gpicker").googleDrivePicker({onPick:function(e){Ee(e,"gdrive",t)}}),""!==t&&void 0!==t&&("undefined"!=typeof Dropbox&&document.getElementById("dropbox-chooser-lead").appendChild(Dropbox.createChooseButton({success:function(e){Ee(e,"dropbox",t)},linkType:"preview",extensions:app.options.allowed_files.split(",")})),"undefined"!=typeof leadAttachmentsDropzone&&leadAttachmentsDropzone.destroy(),leadAttachmentsDropzone=new Dropzone("#lead-attachment-upload",appCreateDropzoneOptions({sending:function(e,a,i){i.append("id",t),0===this.getQueuedFiles().length&&i.append("last_file",!0)},success:function(e,t){t=JSON.parse(t),0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&K(t,t.id)}})),i.find('.nav-tabs a[href="'+window.location.hash+'"]').tab("show"),void 0!==(a=i.find("#lead_activity .feed-item:last-child .text").html())?i.find("#lead-latest-activity").html(a):i.find(".lead-latest-activity > .lead-info-heading").addClass("hide"),0<$("[lead-is-junk-or-lost]").length&&$(".form-group-select-input-status").find(".req").remove())}function Z(e,t,a){t=(void 0!==t?t:"leads/lead/")+(void 0!==e?e:""),!0===a&&(a="?",-1<t.indexOf("?")&&(a+="&"),t+=a+"edit=true"),Ue(t).done((function(t){K(t,e)})).fail((function(e){alert_float("danger",e.responseText)}))}function ee(e,t){var a,i,n;t===e.item.parent()[0]&&((a={}).status=$(e.item.parent()[0]).data("lead-status-id"),a.leadid=$(e.item).data("lead-id"),i=[],e=$(e.item).parents(".leads-status").find("li"),n=1,$.each(e,(function(){i.push([$(this).data("lead-id"),n]),n++})),a.order=i,setTimeout((function(){$.post(admin_url+"leads/update_lead_status",a).done((function(e){ae()}))}),200))}function te(){$("#kan-ban").sortable({helper:"clone",item:".kan-ban-col",update:function(e,t){var a=[],i=$(".kan-ban-col"),n=0;$.each(i,(function(){a.push([$(this).data("col-status-id"),n]),n++})),(i={}).order=a,$.post(admin_url+"leads/update_status_order",i)}})}function ae(e){R("leads/kanban",ee,".leads-status",315,360,te)}function ie(e){void 0===e&&(e=$("body").find("textarea[name='checklist-description']")),$.each(e,(function(){var e=$(this).val();$(this).outerHeight()<this.scrollHeight+parseFloat($(this).css("borderTopWidth"))+parseFloat($(this).css("borderBottomWidth"))&&$(this).height(0).height(this.scrollHeight),""===e&&$(this).removeAttr("style")}))}function ne(){var e=$('input[name="checklist-box"]:checked').length,t=$('input[name="checklist-box"]').length,a=0,i=$(".task-progress-bar");if($(".task-total-checklist-completed").text(e),0==t?($("body").find(".chk-heading").remove(),$("#task-no-checklist-items").removeClass("hide")):$("#task-no-checklist-items").addClass("hide"),!(2<t))return i.parents(".progress").addClass("hide"),0<e?$(".chk-toggle-buttons").removeClass("hide"):$(".chk-toggle-buttons").addClass("hide"),!1;i.parents(".progress").removeClass("hide"),a=100*e/t,i.css("width",a.toFixed(2)+"%"),i.text(a.toFixed(2)+"%"),0<e?$(".chk-toggle-buttons").removeClass("hide"):$(".chk-toggle-buttons").addClass("hide"),100==a?i.removeClass("progress-bar-default").addClass("progress-bar-success"):i.removeClass("progress-bar-success").addClass("progress-bar-default")}function se(e,t,a){a&&$(a).addClass("disabled"),t=void 0===t?"":t,$.post(admin_url+"tasks/add_checklist_item",{taskid:e,description:t}).done((function(){!function(e,t){$.post(admin_url+"tasks/init_checklist_items",{taskid:t}).done((function(t){$("#checklist-items").html(t),void 0===e||""===(t=$("#checklist-items").find(".checklist textarea").eq(0)).val()&&t.focus(),ne(),function(){var e,t=[],a=$("body").find(".checklist");0!==a.length&&(e=1,$.each(a,(function(){t.push([$(this).data("checklist-id"),e]),e++})),(a={}).order=t,$.post(admin_url+"tasks/update_checklist_order",a))}()}))}(!0,e)})).always((function(){a&&$(a).removeClass("disabled")}))}function oe(e){var t=$.Deferred();return setTimeout((function(){var a=(a=e.val()).trim(),i=e.parents(".checklist").data("checklist-id");$.post(admin_url+"tasks/update_checklist_item",{description:a,listid:i}).done((function(n){t.resolve(),!0===(n=JSON.parse(n)).can_be_template&&e.parents(".checklist").find(".save-checklist-template").removeClass("hide"),""===a&&$("#checklist-items").find('.checklist[data-checklist-id="'+i+'"]').remove()}))}),300),t.promise()}function de(e,t,a){a=void 0===a?"tasks/mark_as/"+e+"/"+t:a;var i=$("#task-modal").is(":visible");a+="?single_task="+i,$("body").append('<div class="dt-loader"></div>'),Ue(a).done((function(a){$("body").find(".dt-loader").remove(),!0!==a.success&&"true"!=a.success||(le(),i&&ue(a.taskHtml),5==e&&"function"==typeof _maybe_remove_task_from_project_milestone&&_maybe_remove_task_from_project_milestone(t),0===$(".tasks-kanban").length&&alert_float("success",a.message))}))}function le(){$.each([".table-tasks",".table-rel-tasks",".table-rel-tasks-leads",".table-timesheets",".table-timesheets-report"],(function(e,t){$.fn.DataTable.isDataTable(t)&&$(t).DataTable().ajax.reload(null,!1)}))}function re(e,t){e=void 0!==e?e:admin_url+"tasks/task";var a=$("#lead-modal");a.is(":visible")&&(-1===(e+="&opened_from_lead_id="+a.find('input[name="leadid"]').val()).indexOf("?")&&(e=e.replace("&","?")),a.modal("hide")),(a=$("#task-modal")).is(":visible")&&a.modal("hide"),(a=$("#_task_modal")).is(":visible")&&a.modal("hide"),Re(e).done((function(e){$("#_task").html(e),$("body").find("#_task_modal").modal({show:!0,backdrop:"static"}),$("#timer-select-task").is(":visible")&&($(".system-popup-close").click(),window._timer_id=t)})).fail((function(e){alert_float("danger",e.responseText)}))}function ce(e){e.content=void 0===e.content?"":e.content;var t=$("<div/>",{id:"system-popup",class:"system-popup"}).appendTo("body"),a="";return a+='<div class="popup-wrapper fadeIn animated">',a+='<h2 class="popup-message">',a+=e.message,a+="</h2>",a+='<div class="popup-content">',a+=e.content,a+='<button type="button" class="system-popup-close"> </button>',a+="</div>",a+="</div>",t.html(a).removeClass("hide"),$("body").addClass("system-popup"),t.find(".system-popup-close").on("click",(function(){var e=this;Re("misc/clear_system_popup").done((function(a){setTimeout((function(){$("body").removeClass("system-popup"),t.fadeOut(400,(function(){t.remove()})),$(e).off("click")}),50)}))})),t}function pe(e,t){var a="",i=$("#lead-modal"),n=$("#_task_modal");i.is(":visible")?(a+="?opened_from_lead_id="+i.find('input[name="leadid"]').val(),i.modal("hide")):null!=n.attr("data-lead-id")&&(a+="?opened_from_lead_id="+n.attr("data-lead-id")),Re("tasks/get_task_data/"+e+a).done((function(e){ue(e),void 0!==t&&setTimeout((function(){$('[data-task-comment-href-id="'+t+'"]').click()}),1e3)})).fail((function(e){$("#task-modal").modal("hide"),alert_float("danger",e.responseText)}))}function ue(e){var t=$("#task-modal");t.find(".data").html(e),ne(),ie(),setTimeout((function(){t.modal("show"),t.is(":visible")&&I(),L("task"),fe(),is_mobile()&&He(!0)}),150)}function me(){Ue("tasks/get_staff_started_timers").done((function(e){he(e)}))}function he(e){$("#top-timers");var t=$("#top-timers").find(".icon-started-timers");0<e.total_timers?t.removeClass("hide").html(e.total_timers):t.addClass("hide"),$("#started-timers-top").html(e.html)}function fe(){is_mobile()||$("body").find(".task-single-col-left").css("min-height",$("body").find(".task-single-col-right").outerHeight(!0)+"px")}function _e(e,t,a,i,n){var s=$('input[name="'+a+'"]').val();""===s||window.location.hash?window.location.hash&&!e&&(e=window.location.hash.substring(1)):(e=s,$('input[name="'+a+'"]').val("")),void 0!==e&&""!==e&&(destroy_dynamic_scripts_in_element($(t)),$("body").hasClass("small-table")||function(e,t){$("body").toggleClass("small-table");var a,i=$("#small-table");0!==i.length&&(a=!1,i.hasClass("col-md-5")?(i.removeClass("col-md-5").addClass("col-md-12"),a=!0,$(".toggle-small-view").find("i").removeClass("fa fa-angle-double-right").addClass("fa fa-angle-double-left")):(i.addClass("col-md-5").removeClass("col-md-12"),$(".toggle-small-view").find("i").removeClass("fa fa-angle-double-left").addClass("fa fa-angle-double-right")),(e=$(e).DataTable()).columns(hidden_columns).visible(a,!1),e.columns.adjust(),$(t).toggleClass("hide"),$(window).trigger("resize"))}(n,t),$('input[name="'+a+'"]').val(e),function(e){var t;void 0!==history.pushState&&(t={Url:window.location.href},history.pushState(t,"",t.Url),window.location.hash=e)}(e),$(t).load(admin_url+i+"/"+e),is_mobile()&&$("html, body").animate({scrollTop:$(t).offset().top+150},600))}function $e(e){_e(e,"#estimate","estimateid","estimates/get_estimate_data_ajax",".table-estimates")}function ve(e){_e(e,"#proposal","proposal_id","proposals/get_proposal_data_ajax",".table-proposals")}function ge(){var e,t,a=$('input[name="include_shipping"]').prop("checked");for(t in billingAndShippingFields)e="",-1<billingAndShippingFields[t].indexOf("country")?e=$("#"+billingAndShippingFields[t]+" option:selected").data("subtext"):-1<billingAndShippingFields[t].indexOf("shipping_street")||-1<billingAndShippingFields[t].indexOf("billing_street")?$('textarea[name="'+billingAndShippingFields[t]+'"]').length&&(e=$('textarea[name="'+billingAndShippingFields[t]+'"]').val().replace(/(?:\r\n|\r|\n)/g,"<br />")):e=$('input[name="'+billingAndShippingFields[t]+'"]').val(),-1<billingAndShippingFields[t].indexOf("shipping")&&(a||(e="")),void 0===e&&(e=""),e=""!==e?e:"--",$("."+billingAndShippingFields[t]).html(e);$("#billing_and_shipping_details").modal("hide")}function be(e){for(var t=["input","number","date_picker","date_picker_time","colorpicker"],a=0;a<e.length;a++){var i,n=e[a];-1<$.inArray(n.type,t)?$('tr.main td[data-id="'+n.id+'"] input').val(n.value).trigger("change"):"textarea"==n.type?$('tr.main td[data-id="'+n.id+'"] textarea').val(n.value):"select"==n.type||"multiselect"==n.type?empty(n.value)||(i=(i=n.value.split(",")).map((function(e){return e.trim()})),$('tr.main td[data-id="'+n.id+'"] select').selectpicker("val",i)):"checkbox"==n.type&&(empty(n.value)||(i=(i=n.value.split(",")).map((function(e){return e.trim()})),$.each(i,(function(e,t){$('tr.main td[data-id="'+n.id+'"] input[type="checkbox"][value="'+t+'"]').prop("checked",!0)}))))}}function ye(e){var t=$("table.items tbody").find("tr:last-child").find("select").selectpicker("val"),a=$(".main");a.find("textarea").val(""),a.find('td.custom_field input[type="checkbox"]').prop("checked",!1),a.find("td.custom_field input:not(:checkbox):not(:hidden)").val(""),a.find("td.custom_field select").selectpicker("val",""),a.find('input[name="quantity"]').val(1),a.find("select.tax").selectpicker("val",t),a.find('input[name="rate"]').val(""),a.find('input[name="unit"]').val(""),$('input[name="task_id"]').val(""),$('input[name="expense_id"]').val("")}function ke(e,t,a,i){if(""!==(e=void 0===e||"undefined"==e?function(){var e={};return e.description=$('.main textarea[name="description"]').val(),e.long_description=$('.main textarea[name="long_description"]').val(),e.qty=$('.main input[name="quantity"]').val(),e.taxname=$(".main select.tax").selectpicker("val"),e.rate=$('.main input[name="rate"]').val(),e.unit=$('.main input[name="unit"]').val(),e}():e).description||""!==e.long_description||""!==e.rate){var n="",s=k?k+=1:$("body").find("tbody .item").length+1;k=s,n+='<tr class="sortable item" data-merge-invoice="'+a+'" data-bill-expense="'+i+'">',n+='<td class="dragger">',isNaN(e.qty)&&(e.qty=1),(""===e.rate||isNaN(e.rate))&&(e.rate=0);var o=e.rate*e.qty;i="newitems["+s+"][taxname][]";$("body").append('<div class="dt-loader"></div>');var d=/<br[^>]*>/gi;return function(e,t){return jQuery.ajaxSetup({async:!1}),t=$.post(admin_url+"misc/get_taxes_dropdown_template/",{name:e,taxname:t}),jQuery.ajaxSetup({async:!0}),t}(i,e.taxname).done((function(a){n+='<input type="hidden" class="order" name="newitems['+s+'][order]">',n+="</td>",n+='<td class="bold description"><textarea name="newitems['+s+'][description]" class="form-control" rows="5">'+e.description+"</textarea></td>",n+='<td><textarea name="newitems['+s+'][long_description]" class="form-control item_long_description" rows="5">'+e.long_description.replace(d,"\n")+"</textarea></td>";var i=$("tr.main td.custom_field"),l=!1;return 0<i.length&&$.each(i,(function(){var e,t,a,i=$(this).clone(),o="",d=$(this).find("[data-fieldid]"),r="newitems["+s+"][custom_fields][items]["+d.attr("data-fieldid")+"]";d.is(":checkbox")?(t=$(this).find('input[type="checkbox"]:checked'),e=i.find('input[type="checkbox"]'),$.each(e,(function(e,t){var a=Math.random().toString(20).slice(2);$(this).attr("id",a).attr("name",r).next("label").attr("for",a),"1"==$(this).attr("data-custom-field-required")&&(l=!0)})),$.each(t,(function(e,t){i.find('input[value="'+$(t).val()+'"]').attr("checked",!0)})),o=i.html()):d.is("input")||d.is("textarea")?(d.is("input")?i.find("[data-fieldid]").attr("value",d.val()):i.find("[data-fieldid]").html(d.val()),i.find("[data-fieldid]").attr("name",r),"1"==i.find("[data-fieldid]").attr("data-custom-field-required")&&(l=!0),o=i.html()):d.is("select")&&("1"==$(this).attr("data-custom-field-required")&&(l=!0),t=$(this).find("select[data-fieldid]").selectpicker("val"),t=(t=Array(t))[0].constructor===Array?t[0]:t,d=i.find("select"),a=$("<div/>"),d.attr("name",r),d=d.clone(),a.append(d),$.each(t,(function(e,t){a.find('select option[value="'+t+'"]').attr("selected",!0)})),o=a.html()),n+='<td class="custom_field">'+o+"</td>"})),n+='<td><input type="number" min="0" onblur="calculate_total();" onchange="calculate_total();" data-quantity name="newitems['+s+'][qty]" value="'+e.qty+'" class="form-control">',e.unit&&void 0!==e.unit||(e.unit=""),n+='<input type="text" placeholder="'+app.lang.unit+'" name="newitems['+s+'][unit]" class="form-control input-transparent text-right" value="'+e.unit+'">',n+="</td>",n+='<td class="rate"><input type="number" data-toggle="tooltip" title="'+app.lang.item_field_not_formatted+'" onblur="calculate_total();" onchange="calculate_total();" name="newitems['+s+'][rate]" value="'+e.rate+'" class="form-control"></td>',n+='<td class="taxrate">'+a+"</td>",n+='<td class="amount" align="right">'+Se(o,!0)+"</td>",n+='<td><a href="#" class="btn btn-danger pull-left" onclick="delete_item(this,'+t+'); return false;"><i class="fa fa-trash"></i></a></td>',n+="</tr>",$("table.items tbody").append(n),$(document).trigger({type:"item-added-to-table",data:e,row:n}),setTimeout((function(){Te()}),15),i=$('input[name="task_id"]').val(),a=$('input[name="expense_id"]').val(),""!==i&&void 0!==i&&(billed_tasks=i.split(","),$.each(billed_tasks,(function(e,t){$("#billed-tasks").append(hidden_input("billed_tasks["+s+"][]",t))}))),""!==a&&void 0!==a&&(billed_expenses=a.split(","),$.each(billed_expenses,(function(e,t){$("#billed-expenses").append(hidden_input("billed_expenses["+s+"][]",t))}))),$("#item_select").hasClass("ajax-search")&&""!==$("#item_select").selectpicker("val")&&$("#item_select").prepend("<option></option>"),q(),z(),O(),ye(),Ce(),$("body").find("#items-warning").remove(),$("body").find(".dt-loader").remove(),$("#item_select").selectpicker("val",""),l&&$(".invoice-form").length?function(e){appValidateForm($(e=void 0===e?"#invoice-form":e),{clientid:{required:{depends:function(){return!$("select#clientid").hasClass("customer-removed")}}},date:"required",currency:"required",repeat_every_custom:{min:1},number:{required:!0}}),$("body").find('input[name="number"]').rules("add",{remote:{url:admin_url+"invoices/validate_invoice_number",type:"post",data:{number:function(){return $('input[name="number"]').val()},isedit:function(){return $('input[name="number"]').data("isedit")},original_number:function(){return $('input[name="number"]').data("original-number")},date:function(){return $('input[name="date"]').val()}}},messages:{remote:app.lang.invoice_number_exists}})}():l&&$(".estimate-form").length?function(e){appValidateForm($(e=void 0===e?"#estimate-form":e),{clientid:{required:{depends:function(){return!$("select#clientid").hasClass("customer-removed")}}},date:"required",currency:"required",number:{required:!0}}),$("body").find('input[name="number"]').rules("add",{remote:{url:admin_url+"estimates/validate_estimate_number",type:"post",data:{number:function(){return $('input[name="number"]').val()},isedit:function(){return $('input[name="number"]').data("isedit")},original_number:function(){return $('input[name="number"]').data("original-number")},date:function(){return $("body").find('.estimate input[name="date"]').val()}}},messages:{remote:app.lang.estimate_number_exists}})}():l&&$(".proposal-form").length?validate_proposal_form():l&&$(".credit-note-form").length&&function(e){appValidateForm($(e=void 0===e?"#credit-note-form":e),{clientid:{required:{depends:function(){return!$("select#clientid").hasClass("customer-removed")}}},date:"required",currency:"required",number:{required:!0}}),$("body").find('input[name="number"]').rules("add",{remote:{url:admin_url+"credit_notes/validate_number",type:"post",data:{number:function(){return $('input[name="number"]').val()},isedit:function(){return $('input[name="number"]').data("isedit")},original_number:function(){return $('input[name="number"]').data("original-number")},date:function(){return $(".credit_note input[name='date']").val()}}},messages:{remote:app.lang.credit_note_number_exists}})}(),!0})),!1}}function we(e){var t=$("#wrapper").find(".items tbody");0!==t.length&&t.sortable({helper:fixHelperTableHelperSortable,handle:".dragger",placeholder:"ui-placeholder",itemPath:"> tbody",itemSelector:"tr.sortable",items:"tr.sortable",update:function(){(void 0===e?Ce:xe)()},sort:function(e,t){var a=$(e.target);/html|body/i.test(a.offsetParent()[0].tagName)||(a=e.pageY-a.offsetParent().offset().top-t.helper.outerHeight(!0)/2,t.helper.css({top:a+"px"}))}})}function xe(){var e=$(".table.items-preview"),t=e.find("tbody tr"),a=1,i=e.attr("data-type"),n=[];if(!i)return!1;$.each(t,(function(){n.push([$(this).data("item-id"),a]),$(this).find("td.item_no").html(a),a++})),setTimeout((function(){$.post(admin_url+"misc/update_ei_items_order/"+i,{data:n})}),200)}function Ce(){var e=$(".table.has-calculations tbody tr.item"),t=1;$.each(e,(function(){$(this).find("input.order").val(t),t++}))}function Te(){if($("body").hasClass("no-calculate-total"))return!1;var e,t,a,i,n,s={},o=0,d=0,l=1,r=0,c=$(".table.has-calculations tbody tr.item"),p=$("#discount_area"),u=$('input[name="adjustment"]').val(),m=$('input[name="discount_percent"]').val(),h=$('input[name="discount_total"]').val(),f=$(".discount-total-type.selected"),_=$('select[name="discount_type"]').val();$(".tax-area").remove(),$.each(c,(function(){""===(l=$(this).find("[data-quantity]").val())&&(l=1,$(this).find("[data-quantity]").val(1)),n=accounting.toFixed($(this).find("td.rate input").val()*l,app.options.decimal_places),n=parseFloat(n),$(this).find("td.amount").html(Se(n,!0)),o+=n,i=$(this),(a=$(this).find("select.tax").selectpicker("val"))&&$.each(a,(function(a,o){e=n/100*(t=i.find('select.tax [value="'+o+'"]').data("taxrate")),s.hasOwnProperty(o)?s[o]=s[o]+=e:0!=t&&(tax_row='<tr class="tax-area"><td>'+o.split("|")[0]+"("+t+'%)</td><td id="tax_id_'+slugify(o)+'"></td></tr>',$(p).after(tax_row),s[o]=e)}))})),""!==m&&0!=m&&"before_tax"==_&&f.hasClass("discount-type-percent")?r=o*m/100:""!==h&&0!=h&&"before_tax"==_&&f.hasClass("discount-type-fixed")&&(r=h),$.each(s,(function(e,t){""!==m&&0!=m&&"before_tax"==_&&f.hasClass("discount-type-percent")?(total_tax_calculated=t*m/100,t-=total_tax_calculated):""!==h&&0!=h&&"before_tax"==_&&f.hasClass("discount-type-fixed")&&(t-=t*(h/o*100)/100),d+=t,t=Se(t),$("#tax_id_"+slugify(e)).html(t)})),d+=o,""!==m&&0!=m&&"after_tax"==_&&f.hasClass("discount-type-percent")?r=d*m/100:""!==h&&0!=h&&"after_tax"==_&&f.hasClass("discount-type-fixed")&&(r=h),d-=r,u=parseFloat(u),isNaN(u)||(d+=u),c="-"+Se(r),$('input[name="discount_total"]').val(accounting.toFixed(r,app.options.decimal_places)),$(".discount-total").html(c),$(".adjustment").html(Se(u)),$(".subtotal").html(Se(o)+hidden_input("subtotal",accounting.toFixed(o,app.options.decimal_places))),$(".total").html(Se(d)+hidden_input("total",accounting.toFixed(d,app.options.decimal_places))),$(document).trigger("sales-total-calculated")}function Se(e,t){return void 0!==t&&t?accounting.formatMoney(e,{symbol:""}):accounting.formatMoney(e)}function De(e,t){var a=$("body").find(".accounting-template");(a.length||e)&&Ue("misc/get_currency/"+(e||a.find('select[name="currency"]').val())).done((function(e){accounting.settings.currency.decimal=e.decimal_separator,accounting.settings.currency.thousand=e.thousand_separator,accounting.settings.currency.symbol=e.symbol,accounting.settings.currency.format="after"==e.placement?"%v %s":"%s%v",Te(),t&&t()}))}function je(e){""!==e&&Re("proposals/pipeline_open/"+e).done((function(e){var t=0<$(".proposal-pipeline-modal:visible").length;$("#proposal").html(e),t?$("#proposal").find(".modal.proposal-pipeline-modal").removeClass("fade").addClass("in").css("display","block"):$(".proposal-pipeline-modal").modal({show:!0,backdrop:"static",keyboard:!1})}))}function Fe(e){""!==e&&Re("estimates/pipeline_open/"+e).done((function(e){var t=0<$(".estimate-pipeline:visible").length;$("#estimate").html(e),t?$("#estimate").find(".modal.estimate-pipeline").removeClass("fade").addClass("in").css("display","block"):$(".estimate-pipeline").modal({show:!0,backdrop:"static",keyboard:!1})}))}function Ae(e,t){Re(t+"/get_notes/"+e).done((function(e){$("#sales_notes_area").html(e),0<(e=$("#sales-notes-wrapper").attr("data-total"))&&$(".notes-total").html('<span class="badge">'+e+"</span>").removeClass("hide")}))}function ze(e){var t=Oe(e);void 0!==t&&$.each(t,(function(e,a){var i,n;4==a.length&&((i=$("#prefix_year")).hasClass("format-n-yy")?a=a.substr(-2):i.hasClass("format-mm-yyyy")&&("d-m-Y"==app.options.date_format||"d/m/Y"==app.options.date_format||"Y-m-d"==app.options.date_format||"d.m.Y"==app.options.date_format?n=1:"m-d-Y"!=app.options.date_format&&"m.d.Y"!=app.options.date_format&&"m/d/Y"!=app.options.date_format||(n=0),$("#prefix_month").html(t[n])),i.html(a))}))}function Oe(e){var t;return-1<e.indexOf(".")?t=e.split("."):-1<e.indexOf("-")?t=e.split("-"):-1<e.indexOf("/")&&(t=e.split("/")),t}function qe(){"true"!=isRTL?(768>=$(window).width()&&$("body").find(".toggle_view").remove(),$(".horizontal-scrollable-tabs").horizontalTabs()):($(".arrow-left, .arrow-right").css("display","none"),$(".horizontal-scrollable-tabs").removeClass("horizontal-scrollable-tabs"),$(".nav-tabs-horizontal").removeClass("nav-tabs-horizontal"))}function Ne(e){void 0!==e&&$.post(admin_url+"utilities/view_event/"+e).done((function(e){$("#event").html(e),$("#viewEvent").modal("show"),z(),q(),Ie()}))}function Ie(){appValidateForm($("body").find("._event form"),{title:"required",start:"required",reminder_before:"required"},Pe),appValidateForm($("body").find("#viewEvent form"),{title:"required",start:"required",reminder_before:"required"},Pe)}function Pe(e){return $.post(e.action,$(e).serialize()).done((function(e){!0!==(e=JSON.parse(e)).success&&"true"!=e.success||(alert_float("success",e.message),setTimeout((function(){var e=(e=window.location.href).split("?");window.location.href=e[0]}),500))})),!1}function He(e){tinymce.editors.task_comment&&tinymce.remove("#task_comment"),"undefined"!=typeof taskCommentAttachmentDropzone&&taskCommentAttachmentDropzone.destroy(),$("#dropzoneTaskComment").removeClass("hide"),$("#addTaskCommentBtn").removeClass("hide"),taskCommentAttachmentDropzone=new Dropzone("#task-comment-form",appCreateDropzoneOptions({uploadMultiple:!0,clickable:"#dropzoneTaskComment",previewsContainer:".dropzone-task-comment-previews",autoProcessQueue:!1,addRemoveLinks:!0,parallelUploads:20,maxFiles:20,paramName:"file",sending:function(e,t,a){a.append("taskid",$("#addTaskCommentBtn").attr("data-comment-task-id")),tinyMCE.activeEditor?a.append("content",tinyMCE.activeEditor.getContent()):a.append("content",$("#task_comment").val())},success:function(e,t){t=JSON.parse(t),0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&(ue(t.taskHtml),tinymce.remove("#task_comment"))}}));var t=_simple_editor_config();void 0!==e&&!1!==e||(t.auto_focus=!0);e=is_ios();var a=$("#task-modal #taskid").val();t.plugins[0]+=" mention",t.content_style="span.mention {        background-color: #eeeeee;        padding: 3px;    }",t.setup=function(e){e.on("init",(function(){0===$("#mention-autocomplete-css").length&&$("<link>").appendTo("head").attr({id:"mention-autocomplete-css",type:"text/css",rel:"stylesheet",href:site_url+"assets/plugins/tinymce/plugins/mention/autocomplete.css"}),0===$("#mention-css").length&&$("<link>").appendTo("head").attr({type:"text/css",id:"mention-css",rel:"stylesheet",href:site_url+"assets/plugins/tinymce/plugins/mention/rte-content.css"})}))};var i=[];t.mentions={source:function(e,t,n){i.length<1?$.getJSON(admin_url+"tasks/get_staff_names_for_mentions/"+a,(function(e){t(i=e)})):t(i)},insert:function(e){return'<span class="mention" contenteditable="false" data-mention-id="'+e.id+'">@'+e.name+"</span>&nbsp;"}},e||H("#task_comment",t)}function Le(e,t,a,i){(t=$("body").find(t)).length&&(i={ajax:{url:void 0===i?admin_url+"misc/get_relation_data":i,data:function(){var t={};return t.type=e,t.rel_id="",t.q="{{{q}}}",void 0!==a&&jQuery.extend(t,a),t}},locale:{emptyTitle:app.lang.search_ajax_empty,statusInitialized:app.lang.search_ajax_initialized,statusSearching:app.lang.search_ajax_searching,statusNoResults:app.lang.not_results_found,searchPlaceholder:app.lang.search_ajax_placeholder,currentlySelected:app.lang.currently_selected},requestDelay:500,cache:!1,preprocessData:function(e){for(var t=[],a=e.length,i=0;i<a;i++){var n={value:e[i].id,text:e[i].name};e[i].subtext&&(n.data={subtext:e[i].subtext}),t.push(n)}return t},preserveSelectedPosition:"after",preserveSelected:!0},t.data("empty-title")&&(i.locale.emptyTitle=t.data("empty-title")),t.selectpicker().ajaxSelectPicker(i))}function Ee(e,t,a){$.post(admin_url+"leads/add_external_attachment",{files:e,lead_id:a,external:t}).done((function(){Z(a)}))}function Je(e,t){var a={};a.rel_id=$("body").find('input[name="_attachment_sale_id"]').val(),a.type=$("body").find('input[name="_attachment_sale_type"]').val(),a.files=e,a.external=t,$.post(admin_url+"misc/add_sales_external_attachment",a).done((function(){"estimate"==a.type?($("body").hasClass("estimates-pipeline")?Fe:$e)(a.rel_id):"proposal"==a.type?($("body").hasClass("proposals-pipeline")?je:ve)(a.rel_id):"function"==typeof window["init_"+a.type]&&window["init_"+a.type](a.rel_id),$("#sales_attach_file").modal("hide")}))}function Me(e){for(var t=$("#search-history"),a="",i=0;i<e.length;i++)a+='<li data-index="'+i+'"><a href="#" class="history">'+e[i]+' <span class="remove-history pointer pull-right" style="z-index:1500"><i class="fa fa-remove"></i></span></a></li>';t.html(a)}function Re(e,t){return t=void 0===t?{}:t,e={type:"GET",url:-1<e.indexOf(admin_url)?e:admin_url+e},$.ajax($.extend({},e,t))}function Ue(e,t){return(t=void 0===t?{}:t).dataType="json",Re(e,t)}$("body").on("loaded.bs.select change","select.ajax-search",(function(e){var t,a=$(this).selectpicker("val");Array.isArray(a)&&0==a.length||!a||$(this).is(":disabled")||0===(t=$(this).parents(".bootstrap-select.ajax-search")).find(".ajax-clear-values").length&&(a=$(this).attr("id"),t.addClass("ajax-remove-values-option").find("button.dropdown-toggle").after('<span class="pointer ajax-clear-values" onclick="deselect_ajax_search(this); return false;" data-id="'+a+'"><i class="fa fa-remove"></i></span>'))})),$("body").on("rendered.bs.select","select",(function(){$(this).parents().removeClass("select-placeholder"),$(this).parents(".form-group").find(".select-placeholder").removeClass("select-placeholder")})),$("body").on("loaded.bs.select","select",(function(){1==$(this).data("toggle")&&$(this).selectpicker("toggle")})),$("body").on("loaded.bs.select","._select_input_group",(function(e){$(this).parents(".form-group").find(".input-group-select .input-group-addon").css("opacity","1")})),$(window).on("load resize",(function(e){$("body").hasClass("page-small")||D(),setTimeout((function(){S()}),"load"==e.type?150:0)})),$(document).on("mousemove",(function(e){!is_mobile()&&$("body").hasClass("hide-sidebar")&&e.pageX<=10&&$(".hide-menu").click()})),$((function(){0<totalUnreadNotifications&&(document.title="("+totalUnreadNotifications+") "+m),$(".screen-options-btn").on("click",(function(){$(".screen-options-area").slideToggle()})),$("body").hasClass("has-deprecated-errors")&&(P=$("div:contains('A PHP Error was encountered')"),ee=0,$.each(P,(function(){ee+=$(this).outerHeight(),$(this).css("background","#fff")})),0<ee&&$("#menu, #setup-menu-wrapper").css("top",ee+70+"px")),$("form").has('[data-entities-encode="true"]').on("submit.app.entity",(function(e){$(this).validate().checkForm()&&$.each($('[data-entities-encode="true"]'),(function(){$(this).hasClass("_entities-processed")||($(this).val(htmlEntities($(this).val())),$(this).addClass("_entities-processed"))}))})),add_hotkey("Shift+C",(function(){var e=$("#lead-modal"),t=$("#task-modal");e.is(":visible")?function(e){var t=$("#lead-modal"),a="hidden.bs.modal.convert";t.on(a,(function(){t.find(".data").html(""),Re("leads/get_convert_data/"+e).done((function(e){$("#lead_convert_to_customer").html(e),$("#convert_lead_to_client_modal").modal({show:!0,backdrop:"static",keyboard:!1})})).fail((function(e){alert_float("danger",e.responseText)})).always((function(){t.off(a)}))})),t.modal("hide")}(e.find('input[name="leadid"]').val()):t.is(":visible")?((t=t.find(".tasks-comments")).is(":visible")||t.css("display","block"),He()):window.location.href=admin_url+"clients/client"})),add_hotkey("Shift+I",(function(){window.location.href=admin_url+"invoices/invoice"})),add_hotkey("Shift+E",(function(){var e=$("#lead-modal"),t=$("#task-modal");e.is(":visible")||t.is(":visible")?e.is(":visible")?$("a[lead-edit]").click():t.is(":visible")&&function(e){Re("tasks/task/"+e).done((function(e){$("#_task").html(e),$("#task-modal").modal("hide"),$("body").find("#_task_modal").modal({show:!0,backdrop:"static"})}))}(t.find("[data-task-single-id]").attr("data-task-single-id")):window.location.href=admin_url+"estimates/estimate"})),add_hotkey("Shift+F",(function(){var e=$("#task-modal");e.is(":visible")&&5!=(e=e.find("[data-task-single-id]")).attr("data-status")&&function(e){de(5,e)}(e.attr("data-task-single-id"))})),add_hotkey("Ctrl+Shift+P",(function(){window.location.href=admin_url+"proposals/proposal"})),add_hotkey("Ctrl+Shift+E",(function(){window.location.href=admin_url+"expenses/expense"})),add_hotkey("Shift+L",(function(){G()})),add_hotkey("Shift+T",(function(){var e=$(".new-task-relation");0<e.length?re(admin_url+"tasks/task?rel_id="+e.attr("data-rel-id")+"&rel_type="+e.attr("data-rel-type")):$("body").hasClass("project")?re(admin_url+"tasks/task?rel_id="+project_id+"&rel_type=project"):re()})),add_hotkey("Shift+Q",(function(){window.location.href=admin_url+"Service/1"})),add_hotkey("Shift+U",(function(){window.location.href=admin_url+"Service/10"})),add_hotkey("Shift+J",(function(){window.location.href=admin_url+"legalservices/sessions"})),add_hotkey("Shift+S",(function(){window.location.href=admin_url+"tickets/add"})),add_hotkey("Ctrl+Shift+S",(function(){window.location.href=admin_url+"staff/member"})),add_hotkey("Ctrl+Shift+L",(function(){!function(){if(0<$(".started-timers-top").find("li.timer").length)return ce({message:" ",content:$("#timers-logout-template-warning").html()}).find(".popup-message").addClass("hide"),!1;window.location.href=admin_url+"authentication/logout"}()})),add_hotkey("Alt+D",(function(){window.location.href=admin_url})),add_hotkey("Alt+C",(function(){window.location.href=admin_url+"clients"})),add_hotkey("Alt+T",(function(){window.location.href=admin_url+"tasks/list_tasks"})),add_hotkey("Alt+I",(function(){window.location.href=admin_url+"invoices/list_invoices"})),add_hotkey("Alt+E",(function(){window.location.href=admin_url+"estimates/list_estimates"})),add_hotkey("Alt+Q",(function(){window.location.href=admin_url+"Service/1"})),add_hotkey("Alt+U",(function(){window.location.href=admin_url+"Service/22"})),add_hotkey("Alt+J",(function(){window.location.href=admin_url+"legalservices/sessions"})),add_hotkey("Alt+L",(function(){window.location.href=admin_url+"leads"})),add_hotkey("Ctrl+Alt+T",(function(){window.location.href=admin_url+"tickets"})),add_hotkey("Ctrl+Alt+E",(function(){window.location.href=admin_url+"expenses/list_expenses"})),add_hotkey("Alt+R",(function(){window.location.href=admin_url+"reports/sales"})),add_hotkey("Alt+S",(function(){window.location.href=admin_url+"settings"})),add_hotkey("Shift+K",(function(){$("#search_input").focus()})),add_hotkey("Shift+D",(function(){$("body .dataTables_wrapper").eq(0).find(".dataTables_filter input").focus()})),add_hotkey("Shift+F",(function(){$(".hide-menu").click()})),$.Shortcuts.start(),$(document).on("focusin",(function(e){$(e.target).closest(".mce-window").length&&e.stopImmediatePropagation()})),1!=app.options.show_setup_menu_item_only_on_hover||is_mobile()||l.hover((function(){setTimeout((function(){w.css("display","block")}),200)}),(function(){setTimeout((function(){w.css("display","none")}),1e3)}));var k=$("body").find("ul.nav-tabs");o&&k.find('[href="#'+o+'"]').click(),d&&(k.find("li").not('[role="presentation"]').removeClass("active"),k.find('[data-group="'+d+'"]').parents("li").addClass("active")),moment.locale(app.locale),moment().tz(app.options.timezone).format(),H(),$("body").on("click","#started-timers-top,.popover-top-timer-note",(function(e){e.stopPropagation()})),I(),O(),j(),$("body").on("change",".onoffswitch input",(function(e,t){$(this).data("switch-url")&&function(e){var t=0;!0===$(e).prop("checked")&&(t=1),Re($(e).data("switch-url")+"/"+$(e).data("id")+"/"+t)}(this)})),custom_fields_hyperlink(),N(),appProgressBar(),z(),$(document).on("app.form-validate",(function(e,t){return!0===b||(b=!0,void $(t).on("change","select.ajax-search, select.selectpicker",(function(e){var t;$(this).selectpicker("val")&&!$(this).is(":disabled")&&void 0!==$(this).rules()&&1===Object.keys($(this).rules()).length&&$(this).rules().hasOwnProperty("required")&&((t=$(this).parents(".form-group")).find("#"+$(this).attr("name")+"-error").remove(),t.removeClass("has-error"))})))})),q(),D(),L(),Le("customer","#clientid.ajax-search");var x=l.find('li > a[href="'+location+'"]');x.length&&(x.parents("li").not(".quick-links").addClass("active"),x.prop("aria-expanded",!0),x.parents("ul.nav-second-level").prop("aria-expanded",!0),x.parents("li").find("a:first-child").prop("aria-expanded",!0)),!c.hasClass("display-block")||(te=c.find('li > a[href="'+location+'"]')).length&&(te.parents("li").addClass("active"),te.prev("active"),te.parents("ul.nav-second-level").prop("aria-expanded",!0),te.parents("li").find("a:first-child").prop("aria-expanded",!0)),l.metisMenu(),c.metisMenu(),$(".hide-menu").click((function(e){e.preventDefault(),$("body").hasClass("hide-sidebar")?$("body").removeClass("hide-sidebar").addClass("show-sidebar"):$("body").removeClass("show-sidebar").addClass("hide-sidebar"),c.hasClass("display-block")&&$(".close-customizer").click()})),is_mobile()&&r.on("click",(function(){$("body").hasClass("show-sidebar")&&$(".hide-menu").click(),c.hasClass("display-block")&&$(".close-customizer").click()})),"safari"==app.browser&&$("body").on("input",".bootstrap-select .bs-searchbox input",(function(){$(this).trigger("keyup")})),S(),qe(),$("#top-timers").on("click",(function(){me()})),Me(app.user_recent_searches),$("#search-history").on("click",".remove-history",(function(e){e.stopImmediatePropagation(),e.preventDefault();var t=$(this).parents("li").index();Re("misc/remove_recent_search/"+t).done((function(e){var a=$("#search-history");a.find("li:eq("+t+")").remove(),0==a.find("li").length&&a.removeClass("display-block")}))})),$("#search_input").on("click focus",(function(){var e;""==$(this).val()&&(0<(e=$("#search-history")).find("li").length&&e.css("width",$(this).outerWidth()+"px"),e.addClass("display-block"))})),$("#search-history").on("click","a.history",(function(e){e.preventDefault(),e=$(this).text().trim(),$("#search_input").val(e),$("#search_input").trigger("paste")})),$("#search_input").on("keyup paste"+("safari"==app.browser?" input":""),(function(){var t=$("#search-history");t.removeClass("display-block");var a=$(this).val().trim(),i=$("#search_results"),n=$("#top_search_button button");if(""===a)return r.unhighlight(),i.html(""),e="",n.html('<i class="fa fa-search"></i>').removeClass("search_remove"),void t.addClass("display-block");a.length<2&&-1===app.user_language.indexOf("chinese")&&-1===app.user_language.indexOf("japanese")||(n.html('<i class="fa fa-remove"></i>').addClass("search_remove"),delay((function(){a!=e&&$.post(admin_url+"misc/search",{q:a}).done((function(t){t=JSON.parse(t),r.unhighlight(),i.html(t.results),r.highlight(a),e=a,Me(t.history)}))}),700))}));var P=get_url_param("q");if(P&&$("#search_input").val(P).trigger("keyup"),$("body").on("blur","#timesheet_duration",(function(){var e,t,a=$(this),i=$(this).val();-1<(i=i.replace(/[^0-9:]/gi,"")).indexOf(":")?(0===(e=i.split(":"))[0].length&&(e[0]="00"),60<=e[1]&&(t=Math.floor(parseInt(e[1]/60)),e[0]=t+parseInt(e[0]),e[1]=e[1]-60*t),1===e[0].toString().length&&(e[0]="0"+e[0]),1===e[1].toString().length?e[1]="0"+e[1]:0===e[1].toString().length&&(e[1]="00"),i=e[0]+":"+e[1]):1===i.length&&-1===i.indexOf(":")?i="0"+i+":00":2<=i.length&&-1===i.indexOf(":")&&(i+=":00"),i="00:00"==i?"":i,a.val(i)})),$("body").on("click",".timesheet-toggle-enter-type",(function(e){e.preventDefault(),e=$(this).find("span.switch-to").removeClass("switch-to").addClass("hide"),$(this).find("span").not(e).removeClass("hide").addClass("switch-to"),$(".timesheet-start-end-time, .timesheet-duration").toggleClass("hide"),$(".timesheet-start-end-time input").val(""),$(".timesheet-duration input").val("")})),$("body").on("hidden.bs.modal",".modal-reminder",(function(e){var t=$(this),a=t.find('input[name="rel_id"]').val(),i=t.find('input[name="rel_type"]').val();t.find("form").attr("action",admin_url+"misc/add_reminder/"+a+"/"+i),t.find("form").removeAttr("data-edit"),t.find(":input:not([type=hidden]), textarea").val(""),t.find('input[type="checkbox"]').prop("checked",!1),t.find("select").selectpicker("val","")})),$("body").on("shown.bs.modal",".modal-reminder",(function(e){0==$(this).find('form[data-edit="true"]').length&&$(this).find("#date").focus()})),$("body").on("click",".delete-reminder",(function(){return confirm_delete()&&Ue($(this).attr("href")).done((function(e){alert_float(e.alert_type,e.message),$("#task-modal").is(":visible")&&ue(e.taskHtml),J()})),!1})),$("body").on("keypress",'textarea[name="checklist-description"]',(function(e){if("13"==e.which){var t=$(this);return oe(t).done((function(){se(t.attr("data-taskid"))})),!1}})),$("body").on("blur paste",'textarea[name="checklist-description"]',(function(){oe($(this))})),$("body").on("show.bs.select","select.checklist-items-template-select",C),$("body").on("refreshed.bs.select","select.checklist-items-template-select",C),$("body").on("changed.bs.select","select.custom-field-multi-select",(function(e){var t=$(this).val();$(this).find('option[value=""]').prop("selected",0===t.length),$(this).selectpicker("refresh")})),$("body").on("change",".task-single-inline-field",(function(){var e=$("body").find(".task-single-inline-field"),t={};$.each(e,(function(){var e=$(this).attr("name"),a=$(this).val(),i=$(this).parents(".task-single-inline-wrap");"startdate"==e&&""===a?i.addClass("text-danger"):"startdate"==e&&""!==a&&i.removeClass("text-danger"),("startdate"==e&&""!==a||"startdate"!=e)&&(t[$(this).attr("name")]=a,"startdate"!=e&&""===a?i.css("opacity",.5):i.css("opacity",1))})),e=$("#task-modal").find("[data-task-single-id]").attr("data-task-single-id"),$.post(admin_url+"tasks/task_single_inline_update/"+e,t)})),$("body").on("change","#task-modal #checklist_items_templates",(function(){var e=$(this).val();""!==(e=$(this).find('option[value="'+e+'"]').html().trim())&&(se($("#task-modal").find("[data-task-single-id]").attr("data-task-single-id"),e),$(this).selectpicker("val",""))})),$("body").on("click",".task-date-as-comment-id",(function(e){e.preventDefault(),e=$(this).attr("href").split("#"),e=$("#"+e[e.length-1]).position(),$("#task-modal").scrollTop(e.top)})),$("body").on("click","table.dataTable tbody .tags-labels .label-tag",(function(){$(this).parents("table").DataTable().search($(this).find(".tag").text()).draw(),$("div.dataTables_filter input").focus()})),$("body").on("click","table.dataTable tbody .customer-group-list",(function(){$(this).parents("table").DataTable().search($(this).text()).draw(),$("div.dataTables_filter input").focus()})),$("[data-can-view-own], [data-can-view]").on("change",(function(){var e=$(this).attr("data-can-view-own");1!=(view_chk_selector=$(this).parents("tr").find("td input["+(void 0!==e&&!1!==e?"data-can-view":"data-can-view-own")+"]")).data("not-applicable")&&(view_chk_selector.prop("checked",!1),view_chk_selector.prop("disabled",!0===$(this).prop("checked")))})),"undefined"!=typeof taskid&&""!==taskid&&pe(taskid),$("body").on("change",'input[name="checklist-box"]',(function(){Re(admin_url+"tasks/checkbox_action/"+$(this).parents(".checklist").data("checklist-id")+"/"+(!0===$(this).prop("checked")?1:0)),ne(),$(this).prop("checked")&&$('button[data-hide="1"]').hasClass("hide")&&$(this).closest(".checklist ").addClass("hide")})),$("body").on("keyup paste click","textarea[name='checklist-description']",(function(e){ie($(this))})),$("body").on("click focus","#task_comment",(function(e){He()})),$("body").on("click",".task-single-delete-timesheet",(function(e){var t;e.preventDefault(),confirm_delete()&&(t=$(this).data("task-id"),Re($(this).attr("href")).done((function(e){pe(t),setTimeout((function(){le(),me()}),20)})))})),$("body").on("click",".task-single-add-timesheet",(function(e){e.preventDefault();var t,a=$("body").find('#task-modal input[name="timesheet_start_time"]').val(),i=$("body").find('#task-modal input[name="timesheet_end_time"]').val(),n=$("body").find('#task-modal input[name="timesheet_duration"]').val(),s=$("body").find('#task-modal input[name="ts_start_time"]').val();e=$("body").find('#task-modal input[name="ts_end_time"]').val();(""!==a&&""!==i||""!==n&&""!==s&&""!==e)&&((t={}).timesheet_duration=n,t.start_time=a,t.end_time=i,t.ts_start_time=s,t.ts_end_time=e,t.timesheet_task_id=$(this).data("task-id"),t.note=$("body").find("#task_single_timesheet_note").val(),t.timesheet_staff_id=$("body").find('#task-modal select[name="single_timesheet_staff_id"]').val(),$.post(admin_url+"tasks/log_time",t).done((function(e){!0===(e=JSON.parse(e)).success||"true"==e.success?(pe(t.timesheet_task_id),alert_float("success",e.message),setTimeout((function(){le()}),20)):alert_float("warning",e.message)})))})),$("body").on("click",".copy_task_action",(function(){var e={};return $(this).prop("disabled",!0),e.copy_from=$(this).data("task-copy-from"),e.copy_task_assignees=$("body").find("#copy_task_assignees").prop("checked"),e.copy_task_followers=$("body").find("#copy_task_followers").prop("checked"),e.copy_task_checklist_items=$("body").find("#copy_task_checklist_items").prop("checked"),e.copy_task_attachments=$("body").find("#copy_task_attachments").prop("checked"),e.copy_task_status=$("body").find('input[name="copy_task_status"]:checked').val(),$.post(admin_url+"tasks/copy",e).done((function(e){var t;!0!==(e=JSON.parse(e)).success&&"true"!=e.success||((t=$("#_task_modal")).is(":visible")&&t.modal("hide"),pe(e.new_task_id),le()),alert_float(e.alert_type,e.message)})),!1})),$("body").on("click",".new-task-to-milestone",(function(e){e.preventDefault(),e=$(this).parents(".milestone-column").data("col-status-id"),re(admin_url+"tasks/task?rel_type=project&rel_id="+project_id+"&milestone_id="+e),$('body [data-toggle="popover"]').popover("hide")})),$("body").on("shown.bs.modal","#_task_modal",(function(e){$(e.currentTarget).hasClass("edit")?""!==$(this).find(".tinymce-task").val().trim()&&H(".tinymce-task",{height:200}):$("body").find("#_task_modal #name").focus(),I()})),$("body").on("hidden.bs.modal","#_task_modal",(function(){tinyMCE.remove(".tinymce-task"),"undefined"!=typeof _ticket_message&&(_ticket_message=void 0),null==$(this).attr("data-lead-id")||$(this).attr("data-task-created")||G($(this).attr("data-lead-id")),destroy_dynamic_scripts_in_element($("body #_task_modal")),$("#_task").empty()})),$("body").on("hide.bs.modal","#task-modal",(function(){if(1==$("#lightbox").is(":visible"))return!1;"undefined"!=typeof taskAttachmentDropzone&&taskAttachmentDropzone.destroy();var e=tinyMCE.get("#task_view_description");e&&(e.blur(),tinyMCE.remove("#task_view_description"))})),$("body").on("hidden.bs.modal","#task-modal",(function(){destroy_dynamic_scripts_in_element($(this)),$(this).find(".data").empty()})),$("body").on("shown.bs.modal","#task-modal",(function(){ie(),I(),fe(),$(document).off("focusin.modal");var e=window.location.href;-1<e.indexOf("#comment_")&&$('[data-task-comment-href-id="'+(e=(e=e.split("#comment_"))[e.length-1])+'"]').click()})),$("body").on("blur","#task-modal ul.tagit li.tagit-new input",(function(){setTimeout((function(){!function(){var e=$("#taskTags");$.post(admin_url+"tasks/update_tags",{tags:e.tagit("assignedTags"),task_id:e.attr("data-taskid")})}()}),100)})),$("body").on("change",'select[name="select-assignees"]',(function(){$("body").append('<div class="dt-loader"></div>');var e={};e.assignee=$('select[name="select-assignees"]').val(),""!==e.assignee&&(e.taskid=$(this).attr("data-task-id"),$.post(admin_url+"tasks/add_task_assignees",e).done((function(e){$("body").find(".dt-loader").remove(),e=JSON.parse(e),le(),ue(e.taskHtml)})))})),$("body").on("change",'select[name="select-followers"]',(function(){var e={};e.follower=$('select[name="select-followers"]').val(),""!==e.follower&&(e.taskid=$(this).attr("data-task-id"),$("body").append('<div class="dt-loader"></div>'),$.post(admin_url+"tasks/add_task_followers",e).done((function(e){e=JSON.parse(e),$("body").find(".dt-loader").remove(),ue(e.taskHtml)})))})),$("body").on("click",".close-task-stats",(function(){$("#task-tracking-stats-modal").modal("hide")})),$("body").on("hidden.bs.modal","#task-tracking-stats-modal",(function(){$("#tracking-stats").remove()})),$("body").on("show.bs.modal","#task-tracking-stats-modal",(function(){var e=$("body").find("#task-tracking-stats-chart");setTimeout((function(){"undefined"!=typeof taskTrackingChart&&taskTrackingChart.destroy(),taskTrackingChart=new Chart(e,{type:"line",data:taskTrackingStatsData,options:{legend:{display:!1},responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!0,mode:"single",callbacks:{label:function(e,t){return decimalToHM(e.yLabel)}}},scales:{yAxes:[{ticks:{beginAtZero:!0,min:0,userCallback:function(e,t,a){return decimalToHM(e)}}}]}}})}),800)})),$("body").on("shown.bs.modal","#sync_data_proposal_data",(function(){"lead"==$("#sync_data_proposal_data").data("rel-type")&&$("#lead-modal .data").eq(0).css("height",$("#sync_data_proposal_data .modal-content").height()+80+"px").css("overflow-x","hidden")})),$("body").on("hidden.bs.modal","#sync_data_proposal_data",(function(){"lead"==$("#sync_data_proposal_data").data("rel-type")&&$("#lead-modal .data").prop("style","")})),"undefined"!=typeof openLeadID&&""!==openLeadID&&G(openLeadID,!!get_url_param("edit")),$("body").on("click",".leads-kan-ban .cpicker",(function(){var e=$(this).data("color"),t=$(this).parents(".panel-heading-bg").data("status-id");$.post(admin_url+"leads/change_status_color",{color:e,status_id:t})})),$("body").on("click","[lead-edit]",(function(e){e.preventDefault();var t=$("body .lead-edit");$("body .lead-view").toggleClass("hide"),t.toggleClass("hide"),t.hasClass("hide")||(t=(e=$("#lead-modal").find("#address"))[0].scrollHeight,e.is("textarea")&&(e.height(0).height(t-15),e.css("padding-top","9px")))})),$("body").on("click",".new-lead-from-status",(function(e){e.preventDefault(),e=$(this).parents(".kan-ban-col").data("col-status-id"),Z(void 0,admin_url+"leads/lead?status_id="+e),$('body [data-toggle="popover"]').popover("hide")})),$("body").on("change","input.include_leads_custom_fields",(function(){var e=$(this).val(),t=$(this).data("field-id");2==e?$("#merge_db_field_"+t).removeClass("hide"):$("#merge_db_field_"+t).addClass("hide"),3==e?$("#merge_db_contact_field_"+t):$("#merge_db_contact_field_"+t).addClass("hide")})),0<p.length){Ie();var E={customButtons:{},locale:app.locale,headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},editable:!1,dayMaxEventRows:parseInt(app.options.calendar_events_limit)+1,views:{day:{dayMaxEventRows:!1}},direction:"true"==isRTL?"rtl":"ltr",eventStartEditable:!1,firstDay:parseInt(app.options.calendar_first_day),initialView:app.options.default_view_calendar,timeZone:app.options.timezone,loading:function(e,t){e?$(".dt-loader").removeClass("hide"):$(".dt-loader").addClass("hide")},eventSources:[function(e,t,a){var i={};return $("#calendar_filters").find("input:checkbox:checked").map((function(){i[$(this).attr("name")]=!0})).get(),jQuery.isEmptyObject(i)||(i.calendar_filters=!0),$.getJSON(admin_url+"utilities/get_calendar_data",$.extend({},i,{start:e.startStr,end:e.endStr})).then((function(e){t(e.map((function(e){return $.extend({},e,{start:e.start||e.date,end:e.end||e.date})})))}))}],moreLinkClick:function(e){X.gotoDate(e.date),X.changeView("dayGridDay"),setTimeout((function(){$(".fc-popover-close").click()}),250)},eventDidMount:function(e){var t=$(e.el);t.attr("title",e.event.extendedProps._tooltip),t.attr("onclick",e.event.extendedProps.onclick),t.attr("data-toggle","tooltip"),e.event.extendedProps.url||t.on("click",(function(){Ne(e.event.extendedProps.eventid)}))},dateClick:function(e){return e.dateStr.length<=10&&(e.dateStr+=" 00:00"),e=(new DateFormatter).formatDate(new Date(e.dateStr),vformat=24==app.options.time_format?app.options.date_format+" H:i":app.options.date_format+" g:i A"),$("input[name='start'].datetimepicker").val(e),$("#newEventModal").modal("show"),!1}};if($("body").hasClass("dashboard")&&(E.customButtons.viewFullCalendar={text:app.lang.calendar_expand,click:function(){window.location.href=admin_url+"utilities/calendar"}},E.headerToolbar.left+=",viewFullCalendar"),E.customButtons.calendarFilter={text:app.lang.filter_by.toLowerCase(),click:function(){slideToggle("#calendar_filters")}},E.headerToolbar.right+=",calendarFilter",1==app.user_is_staff_member&&(""!==app.options.google_api&&(E.googleCalendarApiKey=app.options.google_api),""!==app.calendarIDs&&(app.calendarIDs=JSON.parse(app.calendarIDs),0!=app.calendarIDs.length)))if(""!==app.options.google_api)for(var M=0;M<app.calendarIDs.length;M++){var R={};R.googleCalendarId=app.calendarIDs[M],E.eventSources.push(R)}else console.error("You have setup Google Calendar IDs but you dont have specified Google API key. To setup Google API key navigate to Setup->Settings->Google");var X=new FullCalendar.Calendar(p[0],E);X.render(),get_url_param("new_event")&&($("input[name='start'].datetimepicker").val(get_url_param("date")),$("#newEventModal").modal("show"))}$("body").on("change",'select[name="tax"]',(function(){var e=$("body").find('select[name="tax2"]'),t=$(this);""!==t.val()?e.prop("disabled",!1):(e.prop("disabled",!0),""!==e.val()&&(t.selectpicker("val",e.val()),e.val(""),t.selectpicker("refresh"))),e.selectpicker("refresh")})),$("body").on("click","#invoice_create_credit_note",(function(e){if(2==$(this).attr("data-status"))return!0;var t=$("#confirm_credit_note_create_from_invoice");t.modal("show"),t.find("#confirm-invoice-credit-note").attr("href",$(this).attr("href")),e.preventDefault()})),$("body").on("change blur",".apply-credits-to-invoice .apply-credits-field",(function(){var e=$("#apply_credits"),t=e.find("input.apply-credits-field"),a=0,i=e.attr("data-credits-remaining");$.each(t,(function(){var e;!0===$(this).valid()&&(e=$(this).val(),isNaN(e=parseFloat(e))?$(this).val(0):a+=e)})),e.find("#credits-alert").remove(),e.find(".amount-to-credit").html(Se(a)),i<a?($(".credits-table").before($("<div/>",{id:"credits-alert",class:"alert alert-danger"}).html(app.lang.credit_amount_bigger_then_credit_note_remaining_credits)),e.find('[type="submit"]').prop("disabled",!0)):(e.find(".credit-note-balance-due").html(Se(i-a)),e.find('[type="submit"]').prop("disabled",!1))})),$("body").on("change blur",".apply-credits-from-invoice .apply-credits-field",(function(){var e=$("#apply_credits"),t=e.find("input.apply-credits-field"),a=0,i=e.attr("data-balance-due");$.each(t,(function(){var e;!0===$(this).valid()&&(e=$(this).val(),isNaN(e=parseFloat(e))?$(this).val(0):a+=e)})),e.find("#credits-alert").remove(),e.find(".amount-to-credit").html(Se(a)),i<a?($(".credits-table").before($("<div/>",{id:"credits-alert",class:"alert alert-danger"}).html(app.lang.credit_amount_bigger_then_invoice_balance)),e.find('[type="submit"]').prop("disabled",!0)):(e.find(".invoice-balance-due").html(Se(i-a)),e.find('[type="submit"]').prop("disabled",!1))})),$('input[name="notify_type"]').on("change",(function(){var e=$('input[name="notify_type"]:checked').val(),t=$("#specific_staff_notify"),a=$("#role_notify");"specific_staff"==e?(t.removeClass("hide"),a.addClass("hide")):"roles"==e?(t.addClass("hide"),a.removeClass("hide")):"assigned"==e&&(t.addClass("hide"),a.addClass("hide"))})),$("body").on("shown.bs.modal","#lead-modal",(function(e){custom_fields_hyperlink(),0===$("body").find('#lead-modal input[name="leadid"]').length&&$("body").find('#lead-modal input[name="name"]').focus(),qe(),$("body").find(".lead-wrapper").hasClass("open-edit")&&$("body").find("a[lead-edit]").click()})),$("body").on("show.bs.modal","#lead-modal",(function(e){0==$("#lead-more-dropdown").find("li").length&&$("#lead-more-btn").css("opacity",0).css("pointer-events","none")})),$("#lead-modal").on("hidden.bs.modal",(function(e){destroy_dynamic_scripts_in_element($(this)),$(this).data("bs.modal",null),$("#lead_reminder_modal").html(""),$("#lead-modal").is(":visible")||history.pushState("",document.title,window.location.pathname+window.location.search),$("body #lead-modal .datetimepicker").datetimepicker("destroy"),"undefined"!=typeof leadAttachmentsDropzone&&leadAttachmentsDropzone.destroy()})),$("body").on("submit","#lead-modal .consent-form",(function(){var e=$(this).serialize();return $.post($(this).attr("action"),e).done((function(e){Z((e=JSON.parse(e)).lead_id)})),!1})),$("body").on("click",'#lead-modal a[data-toggle="tab"]',(function(){"#tab_lead_profile"==this.hash||"#attachments"==this.hash||"#lead_notes"==this.hash||"#gdpr"==this.hash||"#lead_activity"==this.hash?window.location.hash=this.hash:history.pushState("",document.title,window.location.pathname+window.location.search),$(document).resize()})),$("body").on("click","#lead_enter_activity",(function(){var e=$("#lead_activity_textarea").val(),t=$("#lead-modal").find('input[name="leadid"]').val();""!==e&&$.post(admin_url+"leads/add_activity",{leadid:t,activity:e}).done((function(e){K(e=JSON.parse(e),e.id)})).fail((function(e){alert_float("danger",e.responseText)}))})),$("body").on("submit","#lead-modal #lead-notes",(function(){var e=$(this),t=$(e).serialize();return $.post(e.attr("action"),t).done((function(e){K(e=JSON.parse(e),e.id)})).fail((function(e){alert_float("danger",e.responseText)})),!1}));var ee,te,ae,he,_e;k={custom_view:"[name='custom_view']",assigned:"[name='view_assigned']",status:"[name='view_status[]']",source:"[name='view_source']"};(t=$("table.table-leads")).length&&(x=t.find("#th-consent"),te=[0],P=[0,t.find("#th-assigned").index()],0<x.length&&(te.push(x.index()),P.push(x.index())),(_table_api=F(t,admin_url+"leads/table",P,te,k,[t.find("th.date-created").index(),"desc"]))&&0<x.length&&_table_api.on("draw",(function(){var e=t.find("tbody tr");$.each(e,(function(){$(this).find("td:eq(3)").addClass("bg-light-gray")}))})),$.each(k,(function(e,a){$("select"+a).on("change",(function(){$("[name='view_status[]']").prop("disabled","lost"==$(this).val()||"junk"==$(this).val()).selectpicker("refresh"),t.DataTable().ajax.reload()}))}))),$("body").on("change",'input[name="contacted_today"]',(function(){var e=$(this).prop("checked"),t=$(".lead-select-date-contacted");0==e?t.removeClass("hide"):t.addClass("hide")})),$("body").on("change",'input[name="contacted_indicator"]',(function(){var e=$(".lead-select-date-contacted");"yes"==$(this).val()?e.removeClass("hide"):e.addClass("hide")})),$("body").on("click",".close-reminder-modal",(function(){$(".reminder-modal-"+$(this).data("rel-type")+"-"+$(this).data("rel-id")).modal("hide")})),$("form").not("#single-ticket-form,#calendar-event-form,#proposal-form").areYouSure(),$("body").on("click",".editor-add-content-notice",(function(){var e=$(this);setTimeout((function(){e.remove(),tinymce.triggerSave()}),500)})),$(".bulk_actions").on("change",'input[name="mass_delete"]',(function(){var e=$("#bulk_change");!0===$(this).prop("checked")&&e.find("select").selectpicker("val",""),e.toggleClass("hide"),$(".mass_delete_separator").toggleClass("hide")})),$("body").on("change loaded.bs.select","#item_select",(function(){var e=$(".items-wrapper .items-select-wrapper"),t=$(".items-wrapper .input-group-addon");0===t.length?$(".items-wrapper .bootstrap-select").css("width","100%"):$(".items-wrapper .bootstrap-select").css("width",e.width()-t.width()+12+"px")})),$(".send-test-sms").on("click",(function(){var e=$(this).data("id"),t=$('#sms_test_response[data-id="'+e+'"]'),a=$('textarea[data-id="'+e+'"]').val(),i=$('input.test-phone[data-id="'+e+'"]').val(),n=$(this);t.empty(),""!=(a=a.trim())&&""!=i&&(n.prop("disabled",!0),$.post(window.location.href,{message:a,number:i,id:e,sms_gateway_test:!0}).done((function(e){1==(e=JSON.parse(e)).success?t.html('<div class="alert alert-success no-mbot mtop15">SMS Sent Successfully!</div>'):t.html('<div class="alert alert-warning no-mbot mtop15">'+e.error+"</div>")})).always((function(){n.prop("disabled",!1)})))})),$("body").on("hidden.bs.modal","#__todo",(function(){var e=$("#__todo");e.find('input[name="todoid"]').val(""),e.find('textarea[name="description"]').val(""),e.find(".add-title").addClass("hide"),e.find(".edit-title").addClass("hide")})),$("body").on("shown.bs.modal","#__todo",(function(){var e=$("#__todo");e.find('textarea[name="description"]').focus(),""!==e.find('input[name="todoid"]').val()?(e.find(".add-title").addClass("hide"),e.find(".edit-title").removeClass("hide")):(e.find(".add-title").removeClass("hide"),e.find(".edit-title").addClass("hide"))})),$("#top_search_button button").on("click",(function(){var t=$("#search_input");$(this).hasClass("search_remove")&&($(this).html('<i class="fa fa-search"></i>').removeClass("search_remove"),e="",$("#search_results").html(""),t.val("")),t.focus()})),$("body").click((function(e){$(e.target).parents("#top_search_dropdown").hasClass("search-results")||$("#top_search_dropdown").remove()})),$("body").tooltip({selector:'[data-toggle="tooltip"]'}),$("body").popover({selector:'[data-toggle="popover"]'}),$("body").on("click","._filter_data ul.dropdown-menu li a,.not-mark-as-read-inline,.not_mark_all_as_read a",(function(e){e.stopPropagation(),e.preventDefault()})),$("body").on("shown.bs.modal",".modal",(function(){$("body").addClass("modal-open"),$("body").find("#started-timers-top").parents("li").removeClass("open")})),$("body").on("hidden.bs.modal",".modal",(function(e){$(".modal:visible").length&&$(document.body).addClass("modal-open"),$(this).data("bs.modal",null)})),$(".datepicker.activity-log-date").on("change",(function(){a.DataTable().ajax.reload()})),$(".btn-import-submit").on("click",(function(){$(this).hasClass("simulate")&&$("#import_form").append(hidden_input("simulate",!0)),$("#import_form").submit()})),$("body").on("change","#unlimited_cycles",(function(){$(this).parents(".recurring-cycles").find("#cycles").prop("disabled",$(this).prop("checked"))})),$("body").on("change",'[name="repeat_every"], [name="recurring"]',(function(){var e=$(this).val();"custom"==e?$(".recurring_custom").removeClass("hide"):$(".recurring_custom").addClass("hide"),""!==e&&0!=e?$("body").find("#cycles_wrapper").removeClass("hide"):($("body").find("#cycles_wrapper").addClass("hide"),$("body").find("#cycles_wrapper #cycles").val(0),$("#unlimited_cycles").prop("checked",!0).change())})),$("body").on("change","#mass_select_all",(function(){var e=$(this).data("to-table"),t=(e=$(".table-"+e).find("tbody tr"),$(this).prop("checked"));$.each(e,(function(){$($(this).find("td").eq(0)).find("input").prop("checked",t)}))})),$("body").on("show.bs.modal",".modal.email-template",(function(){H($(this).data("editor-id"),{urlconverter_callback:"merge_field_format_url"})})),$("body").on("hidden.bs.modal",".modal.email-template",(function(){tinymce.remove($(this).data("editor-id"))})),$(".close-customizer").on("click",(function(e){e.preventDefault(),c.addClass("true"==isRTL?"fadeOutRight":"fadeOutLeft"),Re("misc/set_setup_menu_closed")})),$(".open-customizer").on("click",(function(e){e.preventDefault(),c.hasClass("true"==isRTL?"fadeOutRight":"fadeOutLeft")&&c.removeClass("true"==isRTL?"fadeOutRight":"fadeOutLeft"),c.addClass("display-block "+("true"==isRTL?"fadeInRight":"fadeInLeft")),is_mobile()||Re("misc/set_setup_menu_open"),S()})),$("body").on("click",".cpicker",(function(){var e=$(this).data("color");if($(this).hasClass("cpicker-big"))return!1;$(this).parents(".cpicker-wrapper").find(".cpicker-big").removeClass("cpicker-big").addClass("cpicker-small"),$(this).removeClass("cpicker-small","fast").addClass("cpicker-big","fast"),$(this).hasClass("kanban-cpicker")?($(this).parents(".panel-heading-bg").css("background",e),$(this).parents(".panel-heading-bg").css("border","1px solid "+e)):$(this).hasClass("calendar-cpicker")&&$("body").find('._event input[name="color"]').val(e)})),$("body").on("click",".notification_link",(function(){var e=$(this).data("link");e.split("#")[1]||(window.location.href=e)})),$("body").on("click"+("ontouchstart"in window?" touchstart":""),".notifications a.notification-top, .notification_link",(function(e){e.preventDefault();var t,a=$(this),i=a.hasClass("notification_link")?a.data("link"):e.currentTarget.href,n=i.split("#"),s=!0;n[1]&&-1<n[1].indexOf("=")&&(s=!1,t=n[1].split("=")[1],-1<n[1].indexOf("postid")?(y=t,(769<$(window).width()?$(".open_newsfeed.desktop"):$(".open_newsfeed.mobile")).click()):-1<n[1].indexOf("taskid")?(e=void 0,-1<i.indexOf("#comment_")&&(e=(i=i.split("#comment_"))[i.length-1]),pe(t,e)):-1<n[1].indexOf("leadid")?G(t):-1<n[1].indexOf("eventid")&&Ne(t)),a.hasClass("desktopClick")||a.parent("li").find(".not-mark-as-read-inline").click(),s&&setTimeout((function(){window.location.href=n}),50)})),$(".notifications-wrapper").on("show.bs.dropdown",(function(){0<u.find(".notifications").attr("data-total-unread")&&$.post(admin_url+"misc/set_notifications_read").done((function(e){!0!==(e=JSON.parse(e)).success&&"true"!=e.success||(document.title=m,$(".icon-notifications").addClass("hide"))}))})),function(e){if(void 0===e&&($("body").hasClass("dashboard")||$("body").hasClass("single-ticket")))return!1;if(0!==$("body").find(".tickets-table").length){var t={},a=$("._hidden_inputs._filters.tickets_filters input"),i=$("table.tickets-table thead .ticket_created_column").index();if($.each(a,(function(){t[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'})),t.project_id='[name="project_id"]',e=[0],a=admin_url+"tickets",$("body").hasClass("tickets-page")&&(a+="?bulk_actions=true"),(_table_api=F(".tickets-table",a,e,e,t,[i,"desc"]))&&$("body").hasClass("dashboard")){var n,s=[4,i,5,6];for(n in s)_table_api.column(s[n]).visible(!1,!1);_table_api.columns.adjust()}}}(),function(e){if(void 0===e&&$("body").hasClass("dashboard"))return!1;F(".table-announcements",admin_url+"announcements",void 0,void 0,"undefined",[1,"desc"])}(),function(e){var t;if(void 0===e&&$("body").hasClass("dashboard"))return!1;0!==$("body").find(".table-staff-projects").length&&(t={},e=$("._hidden_inputs._filters.staff_projects_filter input"),$.each(e,(function(){t[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'})),F(".table-staff-projects",admin_url+"projects/staff_projects","undefined","undefined",t,[2,"asc"]))}(),(a=$("table.table-activity-log")).length&&((k=[]).activity_log_date='[name="activity_log_date"]',F(a,window.location.href,"undefined","undefined",k,[1,"desc"])),n=$("table.table-invoices"),i=$("table.table-estimates"),(0<n.length||0<i.length)&&(ae={},_e=$("._hidden_inputs._filters input"),$.each(_e,(function(){ae[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'})),n.length&&F(n,admin_url+"invoices/table"+($("body").hasClass("recurring")?"?recurring=1":""),"undefined","undefined",ae,$("body").hasClass("recurring")?[n.find("th.next-recurring-date").index(),"asc"]:[[3,"desc"],[0,"desc"]]),i.length&&F(i,admin_url+"estimates/table","undefined","undefined",ae,[[3,"desc"],[0,"desc"]])),(s=$(".table-tasks")).length&&(he={},_e=$("._hidden_inputs._filters._tasks_filters input"),$.each(_e,(function(){he[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'})),ye=[0],_e=admin_url+"tasks/table",$("body").hasClass("tasks-page")&&(_e+="?bulk_actions=true"),(_table_api=F(s,_e,ye,ye,he,[s.find("th.duedate").index(),"asc"]))&&$("body").hasClass("dashboard")&&_table_api.column(5).visible(!1,!1).column(6).visible(!1,!1).columns.adjust()),$("#send_file").on("show.bs.modal",(function(e){var t=$("#send_file");t.find('input[name="filetype"]').val($($(e.relatedTarget)).data("filetype")),t.find('input[name="file_path"]').val($($(e.relatedTarget)).data("path")),t.find('input[name="file_name"]').val($($(e.relatedTarget)).data("file-name")),0<$('input[name="email"]').length&&t.find('input[name="send_file_email"]').val($('input[name="email"]').val())})),$("#send_file form").on("submit",(function(){$(this).find('button[type="submit"]').prop("disabled",!0)})),$("body").on("change",'input[name="send_set_password_email"]',(function(){$("body").find(".client_password_set_wrapper").toggleClass("hide")})),$("body").on("change",'.todo input[type="checkbox"]',(function(){var e=!0===$(this).prop("checked")?1:0,t=$(this).val();window.location.href=admin_url+"todo/change_todo_status/"+t+"/"+e}));var ye=$(".todos-sortable");0<ye.length&&(ye=ye.sortable({connectWith:".todo",items:"li",handle:".dragger",appendTo:"body",update:function(e,t){this===t.item.parent()[0]&&A()}})),$("body").on("click",".open_newsfeed, .close_newsfeed",(function(e){e.preventDefault(),void 0===$(this).data("close")?Re("newsfeed/get_data").done((function(e){$("#newsfeed").html(e),V(y),"undefined"==typeof newsFeedDropzone&&$("body").on("submit","#new-post-form",(function(){return $.post(this.action,$(this).serialize()).done((function(e){if((e=JSON.parse(e)).postid){if(0<newsFeedDropzone.getQueuedFiles().length)return newsFeedDropzone.options.url=admin_url+"newsfeed/add_post_attachments/"+e.postid,void newsFeedDropzone.processQueue();Y(e.postid),U()}})),!1})),newsFeedDropzone=new Dropzone("#new-post-form",appCreateDropzoneOptions({clickable:".add-post-attachments",autoProcessQueue:!1,addRemoveLinks:!0,parallelUploads:app.options.newsfeed_maximum_files_upload,maxFiles:app.options.newsfeed_maximum_files_upload,dragover:function(e){$("#new-post-form").addClass("dropzone-active")},complete:function(e){},drop:function(e){$("#new-post-form").removeClass("dropzone-active")},success:function(e,t){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&(Y((t=JSON.parse(t)).postid),U(),this.removeAllFiles())}})),q(),N()})):!0===$(this).data("close")&&(newsFeedDropzone.destroy(),$("#newsfeed").html(""),y=void(_=f=h=0)),$("#newsfeed").toggleClass("hide"),$("body").toggleClass("noscroll")})),0<$("[data-newsfeed-auto]").length&&(769<$(window).width()?$(".open_newsfeed.desktop"):$(".open_newsfeed.mobile")).click(),$("body").on("keyup",".comment-input input",(function(e){13==e.keyCode&&W(this)})),$("#modal_post_likes").on("show.bs.modal",(function(e){f=0,$("#modal_post_likes_wrapper").empty(),$(".likes_modal .modal-footer").removeClass("hide");var t=$(e.relatedTarget);e=$(t).data("postid");v=$(t).data("total-pages"),$(".load_more_post_likes").attr("data-postid",e),B(e)})),$("#modal_post_comment_likes").on("show.bs.modal",(function(e){$("#modal_comment_likes_wrapper").empty(),_=0,$(".likes_modal .modal-footer").removeClass("hide");var t=$(e.relatedTarget);e=$(t).data("commentid");g=$(t).data("total-pages"),$(".load_more_post_comment_likes").attr("data-commentid",e),Q(e)})),$(".load_more_post_likes").on("click",(function(e){e.preventDefault(),B($(this).data("postid"))})),$(".load_more_post_comment_likes").on("click",(function(e){e.preventDefault(),Q($(this).data("commentid"))})),$(".add-attachments").on("click",(function(e){e.preventDefault(),$("#post-attachments").toggleClass("hide")})),function(e){var t,a,i;0!==$("#invoices_total").length&&(a=$(".invoices-total-inline"),i=$(".invoices-total"),$("body").hasClass("invoices-total-manual")&&void 0===e&&!i.hasClass("initialized")||(0<a.length&&i.hasClass("initialized")?a.removeClass("invoices-total-inline"):(i.addClass("initialized"),e=$("body").find('select[name="invoices_total_years"]').selectpicker("val"),t=[],$.each(e,(function(e,a){""!==a&&t.push(a)})),a={currency:$("body").find('select[name="total_currency"]').val(),years:t,init_total:!0},i=$('input[name="project_id"]').val(),e=$('.customer_profile input[name="userid"]').val(),void 0!==i?a.project_id=i:void 0!==e&&(a.customer_id=e),$.post(admin_url+"invoices/get_invoices_total",a).done((function(e){$("#invoices_total").html(e)})))))}(),function(){var e,t,a,i,n;0!==$("#expenses_total").length&&(e=$("body").find('select[name="expenses_total_currency"]').val(),i=$("body").find('select[name="expenses_total_years"]').selectpicker("val"),t=[],$.each(i,(function(e,a){""!==a&&t.push(a)})),a="",n=$('.customer_profile input[name="userid"]').val(),void 0!==a&&(a=n),i="",n=$('input[name="project_id"]').val(),void 0!==i&&(i=n),$.post(admin_url+"expenses/get_expenses_total",{currency:e,init_total:!0,years:t,customer_id:a,project_id:i}).done((function(e){$("#expenses_total").html(e)})))}(),function(e){var t,a,i,n,s;0!==$("#estimates_total").length&&(n=$(".estimates-total"),$("body").hasClass("estimates-total-manual")&&void 0===e&&!n.hasClass("initialized")||(n.addClass("initialized"),t=$("body").find('select[name="total_currency"]').val(),s=$("body").find('select[name="estimates_total_years"]').selectpicker("val"),a=[],$.each(s,(function(e,t){""!==t&&a.push(t)})),e=i="",n=$('.customer_profile input[name="userid"]').val(),s=$('input[name="project_id"]').val(),void 0!==n?i=n:void 0!==s&&(e=s),$.post(admin_url+"estimates/get_estimates_total",{currency:t,init_total:!0,years:a,customer_id:i,project_id:e}).done((function(e){$("#estimates_total").html(e)}))))}(),we(),$(".settings-textarea-merge-field").on("click",(function(e){e.preventDefault();var t=$(this).text().trim();(e=$('textarea[name="settings['+$(this).data("to")+']"]')).val(e.val()+"\n"+t)})),$("body").hasClass("estimates-pipeline")&&Fe($('input[name="estimateid"]').val()),$("body").hasClass("proposals-pipeline")&&je($('input[name="proposalid"]').val()),$("body").on("submit","._transaction_form",(function(){Te(),$("body").find("#items-warning").remove();var e=$(this).find("table.items"),t=e.find(".main");return t.find('[name="description"]').length&&0<t.find('[name="description"]').val().trim().length&&0<t.find('[name="rate"]').val().trim().length?(e.before('<div class="alert alert-warning mbot20" id="items-warning">'+app.lang.item_forgotten_in_preview+'<i class="fa fa-angle-double-down pointer pull-right fa-2x" style="margin-top:-4px;" onclick="add_item_to_table(\'undefined\',\'undefined\',undefined); return false;"></i></div>'),$("html,body").animate({scrollTop:$("#items-warning").offset().top}),!1):e.length&&0===e.find(".item").length?(e.before('<div class="alert alert-warning mbot20" id="items-warning">'+app.lang.no_items_warning+"</div>"),$("html,body").animate({scrollTop:$("#items-warning").offset().top}),!1):(Ce(),$('select[name="currency"]').prop("disabled",!1),$('select[name="project_id"]').prop("disabled",!1),$('input[name="date"]').prop("disabled",!1),$(this).find(".transaction-submit").prop("disabled",!0),!0)})),$("body").on("click",".transaction-submit",(function(){var e=$(this),t=e.parents("form._transaction_form");t.valid()&&(e.hasClass("save-as-draft")?t.append(hidden_input("save_as_draft","true")):e.hasClass("save-and-send")?t.append(hidden_input("save_and_send","true")):e.hasClass("save-and-record-payment")?t.append(hidden_input("save_and_record_payment","true")):e.hasClass("save-and-send-later")&&t.append(hidden_input("save_and_send_later","true"))),t.submit()})),$("body").on("submit","#sales-notes",(function(){var e=$(this);if(""!==e.find('textarea[name="description"]').val())return $.post(e.attr("action"),$(e).serialize()).done((function(t){e.find('textarea[name="description"]').val(""),e.hasClass("estimate-notes-form")?Ae(t,"estimates"):e.hasClass("invoice-notes-form")?Ae(t,"invoices"):e.hasClass("proposal-notes-form")?Ae(t,"proposals"):e.hasClass("contract-notes-form")&&Ae(t,"contracts")})),!1})),$("body").on("change",'input[name="show_quantity_as"]',(function(){$("body").find("th.qty").html($(this).data("text"))})),$("body").on("change",'div.credit_note input[name="date"]',(function(){ze($(this).val())})),$("body").on("change",'div.invoice input[name="date"], div.estimate input[name="date"], div.proposal input[name="date"]',(function(){var e,t,a=$(this).val();ze(a),0<$('input[name="isedit"]').length||(e="duedate",t=admin_url+"invoices/get_due_date",0<$("body").find("div.estimate").length?(t=admin_url+"estimates/get_due_date",e="expirydate"):0<$("body").find("div.proposal").length&&(t=admin_url+"proposals/get_due_date",e="open_till"),""===a&&$('input[name="'+e+'"]').val(""),""!==a&&$.post(t,{date:a}).done((function(t){t&&$('input[name="'+e+'"]').val(t)})))})),$("#sales_attach_file").on("hidden.bs.modal",(function(e){$("#sales_uploaded_files_preview").empty(),$(".dz-file-preview").empty()})),"undefined"!=typeof Dropbox&&0<$("#dropbox-chooser-sales").length&&document.getElementById("dropbox-chooser-sales").appendChild(Dropbox.createChooseButton({success:function(e){Je(e,"dropbox")},linkType:"preview",extensions:app.options.allowed_files.split(",")})),0<$("#sales-upload").length&&new Dropzone("#sales-upload",appCreateDropzoneOptions({sending:function(e,t,a){a.append("rel_id",$("body").find('input[name="_attachment_sale_id"]').val()),a.append("type",$("body").find('input[name="_attachment_sale_type"]').val())},success:function(e,t){t=JSON.parse(t);var a=$("body").find('input[name="_attachment_sale_type"]').val(),i="delete_"+a+"_attachment";"estimate"==a?($("body").hasClass("estimates-pipeline")?Fe:$e)(t.rel_id):"proposal"==a?($("body").hasClass("proposals-pipeline")?je:ve)(t.rel_id):"function"==typeof window["init_"+a]&&window["init_"+a](t.rel_id),a="",!0!==t.success&&"true"!=t.success||(a+='<div class="display-block sales-attach-file-preview" data-attachment-id="'+t.attachment_id+'">',a+='<div class="col-md-10">',a+='<div class="pull-left"><i class="attachment-icon-preview fa fa-file-o"></i></div>',a+='<a href="'+site_url+"download/file/sales_attachment/"+t.key+'" target="_blank">'+t.file_name+"</a>",a+='<p class="text-muted">'+t.filetype+"</p>",a+="</div>",a+='<div class="col-md-2 text-right">',a+='<a href="#" class="text-danger" onclick="'+i+"("+t.attachment_id+'); return false;"><i class="fa fa-times"></i></a>',a+="</div>",a+='<div class="clearfix"></div><hr/>',a+="</div>",$("#sales_uploaded_files_preview").append(a))}})),$("body").on("click",".invoice-send-to-client",(function(e){e.preventDefault(),$("#invoice_send_to_client_modal").modal("show")})),$("body").on("click",".estimate-send-to-client",(function(e){e.preventDefault(),$("#estimate_send_to_client_modal").modal("show")})),$("body").on("click",".close-send-template-modal",(function(){$("#estimate_send_to_client_modal").modal("hide"),$("#proposal_send_to_customer").modal("hide")})),$("body").on("change","#include_shipping",(function(){var e=$("#shipping_details");!0===$(this).prop("checked")?e.removeClass("hide"):e.addClass("hide")})),$("body").on("click",".save-shipping-billing",(function(e){ge()})),$("body").on("change",'select[name="currency"]',(function(){De()})),$("body").on("change",'input[name="adjustment"],select.tax',(function(){Te()})),$("body").on("click",".discount-total-type",(function(e){e.preventDefault(),$("#discount-total-type-dropdown").find(".discount-total-type").removeClass("selected"),$(this).addClass("selected"),$(".discount-total-type-selected").html($(this).text()),$(this).hasClass("discount-type-percent")?($(".input-discount-fixed").addClass("hide").val(0),$(".input-discount-percent").removeClass("hide")):($(".input-discount-fixed").removeClass("hide"),$(".input-discount-percent").addClass("hide").val(0),$("#discount_percent-error").remove()),Te()})),$("body").on("change",'select[name="discount_type"]',(function(){""===$(this).val()&&$('input[name="discount_percent"]').val(0),Te()})),$("body").on("change",'input[name="discount_percent"],input[name="discount_total"]',(function(){return""===$('select[name="discount_type"]').val()&&0!=$(this).val()?(alert("You need to select discount type"),$("html,body").animate({scrollTop:0},"slow"),$("#wrapper").highlight($('label[for="discount_type"]').text()),setTimeout((function(){$("#wrapper").unhighlight()}),3e3),!1):void(!0===$(this).valid()&&Te())})),$("body").on("change",".invoice #project_id",(function(){var e,t=$(this).selectpicker("val");""!==t?Ue("tasks/get_billable_tasks_by_project/"+t).done((function(e){T(e,t)})):""!==(e=$("#clientid").selectpicker("val"))?Ue("tasks/get_billable_tasks_by_customer_id/"+e).done((function(e){T(e)})):T([],"")})),$("body").on("change",'select[name="task_select"]',(function(){""!==$(this).selectpicker("val")&&function(e){Ue("tasks/get_billable_task_data/"+e).done((function(t){t.taxname=$("select.main-tax").selectpicker("val");var a=$(".main");a.find('textarea[name="description"]').val(t.name),a.find('textarea[name="long_description"]').val(t.description),a.find('input[name="quantity"]').val(t.total_hours),a.find('input[name="rate"]').val(t.hourly_rate),a.find('input[name="unit"]').val(""),$('input[name="task_id"]').val(e),$(document).trigger({type:"item-added-to-preview",item:t,item_type:"task"})}))}($(this).selectpicker("val"))})),$("body").on("change",'select[name="paymentmode"]',(function(){var e=$(".do_not_redirect");$.isNumeric($(this).val())?e.addClass("hide"):e.removeClass("hide")})),$("body").on("change",".f_client_id #clientid",(function(){var e=$(this).val(),t=$('select[name="project_id"]'),a=t.html("").clone(),i=$(".projects-wrapper");if(t.selectpicker("destroy").remove(),t=a,$("#project_ajax_search_wrapper").append(a),function(e){Le("project",e=void 0===e?"#project_id.ajax-search":e,{customer_id:function(){return $("#clientid").val()}})}(),function(){for(var e in billingAndShippingFields)-1<billingAndShippingFields[e].indexOf("country")?$('select[name="'+billingAndShippingFields[e]+'"]').selectpicker("val",""):($('input[name="'+billingAndShippingFields[e]+'"]').val(""),$('textarea[name="'+billingAndShippingFields[e]+'"]').val("")),"billing_country"==billingAndShippingFields[e]&&($('input[name="include_shipping"]').prop("checked",!1),$('input[name="include_shipping"]').change());ge()}(),!e)return $("#merge").empty(),$("#expenses_to_bill").empty(),$("#invoice_top_info").addClass("hide"),i.addClass("hide"),!1;Ue("invoices/client_change_data/"+e+"/"+(a=void 0===(a=$("body").find('input[name="merge_current_invoice"]').val())?"":a)).done((function(e){$("#merge").html(e.merge_info);var a,n,s=$("#expenses_to_bill");for(a in 0===s.length?e.expenses_bill_info="":s.html(e.expenses_bill_info),""!==e.merge_info||""!==e.expenses_bill_info?$("#invoice_top_info").removeClass("hide"):$("#invoice_top_info").addClass("hide"),billingAndShippingFields)-1<billingAndShippingFields[a].indexOf("billing")&&(-1<billingAndShippingFields[a].indexOf("country")?$('select[name="'+billingAndShippingFields[a]+'"]').selectpicker("val",e.billing_shipping[0][billingAndShippingFields[a]]):(-1<billingAndShippingFields[a].indexOf("billing_street")?$('textarea[name="'+billingAndShippingFields[a]+'"]'):$('input[name="'+billingAndShippingFields[a]+'"]')).val(e.billing_shipping[0][billingAndShippingFields[a]]));for(n in empty(e.billing_shipping[0].shipping_street)||$('input[name="include_shipping"]').prop("checked",!0).change(),billingAndShippingFields)-1<billingAndShippingFields[n].indexOf("shipping")&&(-1<billingAndShippingFields[n].indexOf("country")?$('select[name="'+billingAndShippingFields[n]+'"]').selectpicker("val",e.billing_shipping[0][billingAndShippingFields[n]]):(-1<billingAndShippingFields[n].indexOf("shipping_street")?$('textarea[name="'+billingAndShippingFields[n]+'"]'):$('input[name="'+billingAndShippingFields[n]+'"]')).val(e.billing_shipping[0][billingAndShippingFields[n]]));ge();var o=e.client_currency;s=$("body").find('.accounting-template select[name="currency"]');0!=(o=parseInt(o))?s.val(o):s.val(s.data("base")),T(e.billable_tasks,t.selectpicker("val")),!0===e.customer_has_projects?i.removeClass("hide"):i.addClass("hide"),s.selectpicker("refresh"),De()}))})),0===$("body").find('input[name="isedit"]').length&&$('.f_client_id select[name="clientid"]').change(),$("body").on("click","#get_shipping_from_customer_profile",(function(e){e.preventDefault(),!1===(e=$("#include_shipping")).prop("checked")&&(e.prop("checked",!0),$("#shipping_details").removeClass("hide")),""!==(e=$("#clientid").val())&&Ue("clients/get_customer_billing_and_shipping_details/"+e).done((function(e){$('textarea[name="shipping_street"]').val(e[0].shipping_street),$('input[name="shipping_city"]').val(e[0].shipping_city),$('input[name="shipping_state"]').val(e[0].shipping_state),$('input[name="shipping_zip"]').val(e[0].shipping_zip),$('select[name="shipping_country"]').selectpicker("val",e[0].shipping_country)}))})),"undefined"!=typeof accounting&&(accounting.settings.currency.precision=app.options.decimal_places,accounting.settings.number.thousand=app.options.thousand_separator,accounting.settings.number.decimal=app.options.decimal_separator,accounting.settings.number.precision=app.options.decimal_places,Te()),$("body").on("change",'input[name="invoices_to_merge[]"]',(function(){var e=$(this).prop("checked"),t=$(this).val();!0===e?Ue("invoices/get_merge_data/"+t).done((function(e){$.each(e.items,(function(e,a){""!==a.rel_type&&("task"==a.rel_type?$('input[name="task_id"]').val(a.item_related_formatted_for_input):"expense"==a.rel_type&&$('input[name="expense_id"]').val(a.item_related_formatted_for_input)),be(a.custom_fields),ke(a,"undefined",t)}))})):$("body").find('[data-merge-invoice="'+t+'"]').remove()})),$("body").on("change",'input[name="bill_expenses[]"]',(function(){var e=$(this).prop("checked"),t=$(this).val();!0===e?Ue("invoices/get_bill_expense_data/"+t).done((function(e){$('input[name="expense_id"]').val(t),ke(e,"undefined","undefined",t)})):($("body").find('[data-bill-expense="'+t+'"]').remove(),$("body").find('#billed-expenses input[value="'+t+'"]').remove())})),$("body").on("change",".invoice_inc_expense_additional_info input",(function(){var e,t=$(this).attr("data-content"),a=$("[data-bill-expense="+$(this).attr("data-id")+"] .item_long_description");current_desc_val=(current_desc_val=a.val()).trim(),""!==t&&(!0===$(this).prop("checked")?(e=current_desc_val+"\n"+t,a.val(e.trim())):(a.val(current_desc_val.replace("\n"+t,"")),a.val(current_desc_val.replace(t,""))))}))})),$(document).keyup((function(e){27==e.keyCode&&($(".popup-wrapper").is(":visible")&&$(".popup-wrapper").find(".system-popup-close").click(),$("#search-history").is(":visible")&&$("#search-history").removeClass("display-block"))})),$("#newsfeed").scroll((function(e){(e=$(e.currentTarget))[0].scrollHeight-e.scrollTop()==e.outerHeight()&&V(),$("#newsfeed .close_newsfeed").css("top",$(this).scrollTop()+20+"px")}));